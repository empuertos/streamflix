<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#00FF9D">
    <title>StreamFlix - Movies & TV Shows</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🎬</text></svg>">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #00FF9D;
            --primary-gradient: linear-gradient(135deg, #00FF9D 0%, #00cc7a 100%);
            --secondary: #1a1a2e;
            --dark: #16213e;
            --darker: #0f1419;
            --light: #f0f0f0;
            --text: #e6e6e6;
            --text-secondary: #b8c5d1;
            --accent: #ff2e63;
            --accent-secondary: #ff4757;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-light: 0 4px 20px rgba(0, 255, 157, 0.1);
            --shadow-medium: 0 8px 32px rgba(0, 255, 157, 0.15);
            --shadow-strong: 0 16px 48px rgba(0, 255, 157, 0.2);

            /* Typography Variables */
            --font-family-primary: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            --font-family-heading: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;

            --font-weight-light: 300;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --font-weight-extrabold: 800;

            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            --font-size-5xl: 3rem;
            --font-size-6xl: 3.75rem;
            --font-size-7xl: 4.5rem;

            --line-height-tight: 1.25;
            --line-height-snug: 1.375;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.625;
            --line-height-loose: 2;
            --line-height-extraloose: 2.5;

            --letter-spacing-tight: -0.025em;
            --letter-spacing-normal: 0;
            --letter-spacing-wide: 0.025em;
            --letter-spacing-wider: 0.05em;
            --letter-spacing-widest: 0.1em;
            --letter-spacing-extrawide: 0.15em;
        }

        body {
            background-color: var(--secondary);
            color: var(--text);
            line-height: 1.6;
        }

        header {
            background: linear-gradient(to right, var(--dark), var(--secondary));
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            color: var(--primary);
            font-size: 2rem;
        }

        .logo h1 {
            font-size: 1.8rem;
            background: linear-gradient(to right, var(--primary), #00cc7a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .search-container {
            display: flex;
            gap: 10px;
            position: relative;
        }

        .search-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: radial-gradient(ellipse at center,
                rgba(0, 255, 157, 0.1) 0%,
                rgba(0, 255, 157, 0.05) 30%,
                transparent 70%);
            border-radius: 50px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            animation: pulseGlow 4s ease-in-out infinite;
        }

        .search-container:hover::before {
            opacity: 1;
        }

        .search-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 2px;
            background: var(--primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow:
                0 0 10px var(--primary),
                20px 0 0 #00cc7a,
                -20px 0 0 #ff2e63,
                0 20px 0 var(--primary),
                0 -20px 0 #00cc7a,
                14px 14px 0 #ff2e63,
                -14px -14px 0 var(--primary),
                -14px 14px 0 #00cc7a,
                14px -14px 0 #ff2e63;
            opacity: 0;
            transition: opacity 0.3s ease;
            animation: sparkle 2s ease-in-out infinite;
        }

        .search-container:hover::after {
            opacity: 0.8;
        }

        @keyframes sparkle {
            0%, 100% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        @keyframes pulseGlow {
            0%, 100% {
                opacity: 0;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
        }

        .search-suggestions {
            animation: fadeIn 0.2s ease-in;
        }

        .live-search-results {
            animation: fadeIn 0.2s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .search-suggestion {
            padding: 12px 20px;
            cursor: pointer;
            color: var(--text);
            border-bottom: 1px solid rgba(0,255,157,0.2);
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }

        .search-suggestion:hover {
            background-color: rgba(0,255,157,0.1);
        }

        .search-suggestion mark {
            background-color: var(--primary);
            color: var(--secondary);
            padding: 2px 4px;
            border-radius: 3px;
        }

        .search-suggestion i {
            margin-right: 10px;
            color: var(--primary);
            width: 16px;
        }

        .live-results-header {
            background: rgba(0,255,157,0.1);
        }

        .live-result-card {
            border: 1px solid rgba(0,255,157,0.1);
        }

        .live-result-card:hover {
            background: rgba(0,255,157,0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .live-result-info h4 mark {
            background-color: var(--primary);
            color: var(--secondary);
            padding: 1px 3px;
            border-radius: 2px;
        }

        .live-result-info p mark {
            background-color: rgba(0,255,157,0.3);
            color: var(--text);
            padding: 1px 2px;
            border-radius: 2px;
        }

        .no-live-results {
            background: rgba(255,46,99,0.1);
            border: 1px solid var(--accent);
            border-radius: 10px;
            margin: 15px;
        }

        .search-loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Animated placeholder effect */
        .search-box::placeholder {
            color: rgba(255, 255, 255, 0.6);
            transition: color 0.3s ease;
        }

        .search-box:focus::placeholder {
            color: rgba(0, 255, 157, 0.7);
            animation: placeholderGlow 2s ease-in-out infinite;
        }

        @keyframes placeholderGlow {
            0%, 100% {
                opacity: 0.7;
                text-shadow: 0 0 5px rgba(0, 255, 157, 0.5);
            }
            50% {
                opacity: 1;
                text-shadow: 0 0 10px rgba(0, 255, 157, 0.8);
            }
        }

        /* Typing indicator animation */
        @keyframes typing {
            0% { width: 0; }
            50% { width: 100%; }
            100% { width: 0; }
        }

        .typing-indicator {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 2px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            background: var(--primary);
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .btn:active {
            transform: translateY(-2px) scale(0.98) !important;
            transition: all 0.1s ease !important;
        }

        .category-item:active,
        .year-item:active,
        .trending-item:active {
            transform: translateX(4px) scale(0.98) !important;
            transition: all 0.1s ease !important;
        }

        /* Mobile responsiveness for live search */
        @media (max-width: 768px) {
            .live-search-results {
                position: fixed;
                top: auto;
                left: 10px;
                right: 10px;
                border-radius: 15px;
                z-index: 1001;
                max-height: 400px;
            }

            .live-results-grid {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
                padding: 10px !important;
            }

            .live-result-card {
                padding: 8px !important;
            }

            .live-result-poster img {
                width: 50px !important;
                height: 75px !important;
            }
        }

        .search-box {
            padding: 0.7rem 1rem;
            border-radius: 30px;
            border: 2px solid var(--dark);
            background-color: var(--dark);
            color: var(--text);
            width: 300px;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .search-box::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg,
                var(--primary),
                #00cc7a,
                var(--primary),
                #ff2e63,
                var(--primary));
            background-size: 400% 400%;
            border-radius: 32px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            animation: gradientShift 3s ease-in-out infinite;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            width: 350px;
            box-shadow:
                0 0 20px rgba(0, 255, 157, 0.3),
                0 0 40px rgba(0, 255, 157, 0.1),
                inset 0 0 20px rgba(0, 255, 157, 0.05);
        }

        .search-box:focus::before {
            opacity: 1;
        }

        .search-box:hover {
            border-color: rgba(0, 255, 157, 0.5);
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.2);
        }

        .search-btn {
            background: linear-gradient(135deg, var(--primary) 0%, #00cc7a 100%);
            color: var(--secondary);
            border: none;
            border-radius: 35px;
            padding: 0.8rem 1.8rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
            box-shadow:
                0 4px 15px rgba(0, 255, 157, 0.2),
                0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .search-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                rgba(0, 255, 157, 0.4),
                rgba(255, 255, 255, 0.3),
                transparent);
            transition: left 0.8s ease;
        }

        .search-btn::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg,
                var(--primary),
                #00cc7a,
                var(--primary),
                #ff2e63,
                var(--primary));
            background-size: 300% 300%;
            border-radius: 37px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            animation: gradientShift 4s ease-in-out infinite;
        }

        .search-btn:hover::before {
            left: 100%;
        }

        .search-btn:hover {
            background: linear-gradient(135deg, #00cc7a 0%, #00b369 100%);
            transform: translateY(-4px) scale(1.08) rotate(2deg);
            box-shadow:
                0 8px 25px rgba(0, 255, 157, 0.4),
                0 4px 15px rgba(0, 0, 0, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.2);
        }

        .search-btn:hover::after {
            opacity: 0.7;
        }

        .search-btn:active {
            transform: translateY(-2px) scale(1.05) rotate(1deg);
            transition: all 0.1s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2.5rem 3rem;
        }

        .hero {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.8)),
                          url('https://image.tmdb.org/t/p/original/8rpDcsfLJypbO6vREc0547VKqEv.jpg');
            background-size: cover;
            background-position: center;
            height: 75vh;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 4rem;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
            background-attachment: fixed;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease-in-out;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                rgba(0, 255, 157, 0.1) 0%,
                rgba(255, 46, 99, 0.05) 50%,
                rgba(0, 255, 157, 0.08) 100%);
            animation: heroGlow 4s ease-in-out infinite alternate;
            border-radius: 20px;
        }

        @keyframes heroGlow {
            0% { opacity: 0.3; }
            100% { opacity: 0.7; }
        }

        @media (max-width: 768px) {
            .hero {
                background-attachment: scroll;
            }
        }

        .hero-content {
            max-width: 650px;
            z-index: 2;
            animation: heroFadeIn 1.2s ease-out;
        }

        @keyframes heroFadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero h2 {
            font-size: 3.5rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(to right, var(--primary), #fff, var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 100%;
            animation: gradientShift 3s ease-in-out infinite;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .hero p {
            font-size: 1.3rem;
            margin-bottom: 2.5rem;
            color: var(--light);
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.7);
            line-height: 1.6;
        }

        .hero-btns {
            display: flex;
            gap: 1.5rem;
            position: relative;
        }

        .hero-status {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .hero:hover .hero-status {
            opacity: 1;
        }

        .btn {
            padding: 0.9rem 2rem;
            border-radius: 35px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            border: none;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, #00cc7a 100%);
            color: var(--secondary);
            box-shadow:
                0 4px 15px rgba(0, 255, 157, 0.2),
                0 2px 8px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                rgba(0, 255, 157, 0.4),
                rgba(255, 255, 255, 0.3),
                transparent);
            transition: left 0.8s ease;
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg,
                var(--primary),
                #00cc7a,
                var(--primary),
                #ff2e63,
                var(--primary));
            background-size: 300% 300%;
            border-radius: 37px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            animation: gradientShift 4s ease-in-out infinite;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #00cc7a 0%, #00b369 100%);
            transform: translateY(-6px) scale(1.05) rotate(1deg);
            box-shadow:
                0 10px 30px rgba(0, 255, 157, 0.4),
                0 5px 20px rgba(0, 0, 0, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover::after {
            opacity: 0.8;
        }

        .btn-primary:active {
            transform: translateY(-3px) scale(1.02);
            transition: all 0.1s ease;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--text);
            border: 2px solid var(--text);
            position: relative;
            overflow: hidden;
        }

        .btn-secondary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(0, 255, 157, 0.2),
                rgba(255, 255, 255, 0.1),
                transparent);
            transition: left 0.7s ease;
        }

        .btn-secondary::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg,
                transparent,
                rgba(0, 255, 157, 0.3),
                transparent,
                rgba(255, 46, 99, 0.2),
                transparent);
            background-size: 200% 200%;
            border-radius: 37px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
            animation: gradientShift 5s ease-in-out infinite;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(0, 255, 157, 0.05) 100%);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-6px) scale(1.05) rotate(-1deg);
            box-shadow:
                0 10px 30px rgba(0, 255, 157, 0.15),
                0 5px 20px rgba(0, 0, 0, 0.2),
                inset 0 2px 0 rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover::before {
            left: 100%;
        }

        .btn-secondary:hover::after {
            opacity: 0.6;
        }

        .btn-secondary:active {
            transform: translateY(-3px) scale(1.02);
            transition: all 0.1s ease;
        }

        .section-title {
            font-size: 2rem;
            margin: 3rem 0 2rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title i {
            color: var(--primary);
        }

        .mode-toggle {
            display: flex;
            background-color: var(--dark);
            border-radius: 30px;
            padding: 5px;
            margin-bottom: 2rem;
            width: fit-content;
        }

        .mode-btn {
            padding: 0.7rem 1.5rem;
            border-radius: 30px;
            border: none;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background-color: var(--primary);
            color: var(--secondary);
        }

        .main-content {
            display: flex;
            gap: 3rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .content-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 2rem;
            margin-bottom: 4rem;
            flex: 1;
        }

        .categories-sidebar {
            width: 300px;
            background: var(--dark);
            border-radius: 20px;
            padding: 2rem;
            height: fit-content;
            position: sticky;
            top: 100px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .categories-header {
            border-bottom: 2px solid var(--primary);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .categories-header h3 {
            color: var(--primary);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .categories-section {
            margin-bottom: 2.5rem;
        }

        .categories-section h4 {
            color: var(--text);
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0.8rem 1rem;
            background: rgba(0, 255, 157, 0.12);
            border-radius: 12px;
        }

        .categories-section h4 i {
            color: var(--primary);
        }

        .category-list {
            display: grid;
            gap: 0.5rem;
        }

        .category-item {
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            color: var(--text);
            font-size: 0.9rem;
            border-left: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .category-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 157, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .category-item:hover::before {
            left: 100%;
        }

        .category-item:hover {
            background: rgba(0, 255, 157, 0.15);
            border-left-color: var(--primary);
            transform: translateX(8px) scale(1.02);
            box-shadow: 0 4px 15px rgba(0, 255, 157, 0.1);
        }

        .category-item.active {
            background: rgba(0, 255, 157, 0.25);
            border-left-color: var(--primary);
            color: var(--primary);
            box-shadow: 0 2px 10px rgba(0, 255, 157, 0.2);
        }

        .year-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .year-item {
            padding: 0.6rem 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            text-align: center;
            font-size: 0.85rem;
            color: var(--text);
            position: relative;
            overflow: hidden;
        }

        .year-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 157, 0.08), transparent);
            transition: left 0.5s ease;
        }

        .year-item:hover::before {
            left: 100%;
        }

        .year-item:hover {
            background: rgba(0, 255, 157, 0.12);
            color: var(--primary);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 255, 157, 0.1);
        }

        .trending-list {
            display: grid;
            gap: 0.5rem;
        }

        .trending-item {
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            color: var(--text);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .trending-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 46, 99, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .trending-item:hover::before {
            left: 100%;
        }

        .trending-item:hover {
            background: rgba(255, 46, 99, 0.15);
            color: var(--accent);
            transform: translateX(5px) scale(1.02);
            box-shadow: 0 4px 15px rgba(255, 46, 99, 0.1);
        }

        .trending-badge {
            font-size: 1.2rem;
        }

        .category-count, .year-count {
            background: var(--primary);
            color: var(--secondary);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: auto;
        }

        /* Mobile responsiveness for categories sidebar */
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }

            .categories-sidebar {
                width: 100%;
                position: static;
                margin-bottom: 2rem;
            }

            .categories-section {
                margin-bottom: 1.5rem;
            }

            .year-list {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .year-list {
                grid-template-columns: repeat(3, 1fr);
            }

            .category-list {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .category-item {
                padding: 0.8rem;
                font-size: 0.9rem;
                min-height: 48px; /* Better touch target */
            }

            .year-item {
                padding: 0.8rem;
                min-height: 48px; /* Better touch target */
            }

            .trending-item {
                padding: 0.8rem;
                min-height: 48px; /* Better touch target */
            }

            .mode-btn {
                padding: 0.8rem 1.5rem;
                min-height: 48px; /* Better touch target */
            }
        }

        .content-card {
            background: linear-gradient(
                135deg,
                rgba(26, 26, 46, 0.85) 0%,
                rgba(22, 33, 62, 0.75) 25%,
                rgba(18, 25, 35, 0.80) 50%,
                rgba(15, 20, 25, 0.78) 75%,
                rgba(12, 15, 20, 0.82) 100%
            );
            backdrop-filter: blur(40px) saturate(200%) brightness(1.15) contrast(1.08);
            -webkit-backdrop-filter: blur(40px) saturate(200%) brightness(1.15) contrast(1.08);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 28px;
            overflow: hidden;
            transition: all 0.8s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
            box-shadow:
                0 25px 80px rgba(0, 0, 0, 0.65),
                0 12px 35px rgba(0, 255, 157, 0.12),
                0 6px 18px rgba(255, 46, 99, 0.08),
                inset 0 2px 0 rgba(255, 255, 255, 0.22),
                inset 0 -2px 0 rgba(0, 255, 157, 0.15),
                0 0 0 1px rgba(0, 255, 157, 0.05);
            position: relative;
            height: 320px;
            display: flex;
            flex-direction: column;
            transform: translateZ(0);
        }

        .content-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg,
                rgba(0, 255, 157, 0.08) 0%,
                rgba(255, 46, 99, 0.04) 50%,
                rgba(0, 255, 157, 0.06) 100%);
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: 1;
            border-radius: 24px;
        }

        .content-card::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, rgba(0, 255, 157, 0.3), rgba(255, 46, 99, 0.2));
            border-radius: 26px;
            opacity: 0;
            transition: opacity 0.5s ease;
            z-index: -1;
            filter: blur(8px);
        }

        .content-card:hover {
            transform: translateY(-20px) scale(1.05);
            box-shadow:
                0 35px 100px rgba(0, 0, 0, 0.75),
                0 15px 45px rgba(0, 255, 157, 0.35),
                0 8px 25px rgba(255, 46, 99, 0.20),
                inset 0 2px 0 rgba(255, 255, 255, 0.30);
            border-color: rgba(0, 255, 157, 0.5);
        }

        .content-card:hover::before {
            opacity: 1;
        }

        .content-card:hover::after {
            opacity: 0.6;
        }

        .content-card .card-img {
            transition: transform 0.4s ease, filter 0.4s ease;
        }

        .content-card:hover .card-img {
            transform: scale(1.05);
            filter: brightness(1.1) contrast(1.05);
        }

        .content-card .card-content {
            position: relative;
            z-index: 2;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            flex: 1;
        }

        .card-content {
            padding: 1rem;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            color: white;
            margin-top: auto;
        }

        .card-title {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            color: #fff;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .card-rating {
            color: gold;
        }

        .year-badge, .rating-badge, .type-badge {
            background: rgba(0,255,157,0.15);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .rating-badge {
            color: #ffd700;
        }

        .year-badge {
            color: #4CAF50;
        }

        .type-badge {
            color: #2196F3;
        }

        .card-overview {
            font-size: 0.85rem;
            color: #ccc;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .cast-info {
            margin-top: 12px;
            padding: 12px 0;
            border-top: 1px solid rgba(0,255,157,0.15);
            background: linear-gradient(135deg, rgba(0,255,157,0.02) 0%, rgba(255,46,99,0.01) 100%);
            border-radius: 8px;
        }

        .director-info {
            margin-bottom: 12px;
        }

        .director-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary), #00cc7a);
            color: var(--secondary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,255,157,0.2);
        }

        .cast-members {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .cast-label {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.75rem;
            background: rgba(0,255,157,0.1);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid rgba(0,255,157,0.2);
        }

        .cast-member {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, rgba(26,26,46,0.8), rgba(22,33,62,0.6));
            padding: 6px 10px;
            border-radius: 16px;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            border: 1px solid rgba(0,255,157,0.1);
            position: relative;
            overflow: hidden;
        }

        .cast-member::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,157,0.1), transparent);
            transition: left 0.6s ease;
        }

        .cast-member:hover::before {
            left: 100%;
        }

        .cast-member:hover {
            background: linear-gradient(135deg, rgba(0,255,157,0.15), rgba(0,255,157,0.05));
            border-color: var(--primary);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 12px rgba(0,255,157,0.2);
        }

        .cast-member img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .cast-member:hover img {
            border-color: #00ff9d;
            box-shadow: 0 0 12px rgba(0,255,157,0.4);
            transform: scale(1.1);
        }

        .cast-member-name {
            color: var(--text);
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            transition: color 0.3s ease;
        }

        .cast-member:hover .cast-member-name {
            color: var(--primary);
        }

        .cast-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #999;
            font-size: 0.75rem;
        }

        .image-loading {
            background: linear-gradient(90deg, rgba(0,255,157,0.1) 25%, rgba(0,255,157,0.05) 50%, rgba(0,255,157,0.1) 75%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        .image-error {
            background: linear-gradient(135deg, rgba(255,46,99,0.1), rgba(255,46,99,0.05));
            border: 1px solid rgba(255,46,99,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent);
            font-size: 0.7rem;
            font-weight: bold;
        }

        .image-error::after {
            content: '⚠';
            font-size: 1rem;
        }

        @keyframes imagePulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(0.95);
            }
        }

        .cast-member img[loading="lazy"] {
            animation: imagePulse 2s ease-in-out infinite;
        }

        .cast-member img:not([loading="lazy"]) {
            animation: none;
        }

        .cast-crew-info {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid rgba(0, 255, 157, 0.25);
            background: linear-gradient(135deg, rgba(0,255,157,0.03) 0%, rgba(255,46,99,0.02) 100%);
            border-radius: 12px;
            padding: 2rem;
        }

        .director-section h3, .cast-section h3 {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            margin-bottom: 1.5rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }

        .director-section h3 i, .cast-section h3 i {
            font-size: 1.2rem;
            background: linear-gradient(135deg, var(--primary), #00cc7a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .director-card {
            background: linear-gradient(135deg, rgba(26,26,46,0.9), rgba(22,33,62,0.7));
            border: 2px solid rgba(0,255,157,0.2);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
        }

        .director-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,157,0.1), transparent);
            transition: left 0.8s ease;
        }

        .director-card:hover::before {
            left: 100%;
        }

        .director-card:hover {
            transform: translateY(-4px) scale(1.02);
            border-color: var(--primary);
            box-shadow: 0 8px 25px rgba(0,255,157,0.2);
        }

        .director-profile {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }

        .director-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            transition: all 0.4s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            position: relative;
        }

        .director-card:hover .director-avatar {
            border-color: #00ff9d;
            box-shadow: 0 0 20px rgba(0,255,157,0.4);
            transform: scale(1.05);
        }

        .director-avatar::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, var(--primary), #00cc7a, var(--primary));
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .director-card:hover .director-avatar::after {
            opacity: 0.3;
        }

        .director-details h4 {
            font-size: 1.3rem;
            margin-bottom: 8px;
            color: var(--primary);
            font-weight: 700;
        }

        .director-role {
            background: linear-gradient(135deg, var(--primary), #00cc7a);
            color: var(--secondary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(0,255,157,0.3);
        }

        .cast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .cast-card {
            background: linear-gradient(135deg, rgba(26,26,46,0.8), rgba(22,33,62,0.6));
            border: 2px solid rgba(0,255,157,0.15);
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .cast-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0,255,157,0.08), transparent);
            transition: left 0.7s ease;
        }

        .cast-card:hover::before {
            left: 100%;
        }

        .cast-card:hover {
            background: linear-gradient(135deg, rgba(0,255,157,0.12), rgba(0,255,157,0.04));
            border-color: var(--primary);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0,255,157,0.15);
        }

        .cast-profile {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
        }

        .cast-avatar {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
            transition: all 0.4s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }

        .cast-card:hover .cast-avatar {
            border-color: #00ff9d;
            box-shadow: 0 0 15px rgba(0,255,157,0.4);
            transform: scale(1.05);
        }

        .cast-details h5 {
            font-size: 1rem;
            margin-bottom: 6px;
            color: var(--text);
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .cast-character {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 500;
            background: rgba(0,255,157,0.1);
            padding: 4px 10px;
            border-radius: 15px;
            display: inline-block;
            border: 1px solid rgba(0,255,157,0.2);
        }

        .card-title mark {
            background-color: var(--primary);
            color: var(--secondary);
            padding: 1px 3px;
            border-radius: 2px;
        }

        .card-overview mark {
            background-color: rgba(0,255,157,0.3);
            color: var(--text);
            padding: 1px 2px;
            border-radius: 2px;
        }

        .watch-btn-card {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .watch-btn-card:hover {
            background-color: #ff1a4f;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            display: none;
        }

        .loading-spinner {
            border: 6px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top: 6px solid var(--primary);
            border-right: 6px solid rgba(0, 255, 157, 0.6);
            width: 60px;
            height: 60px;
            animation: spinPulse 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin: 0 auto 1.5rem;
            position: relative;
        }

        .loading-spinner::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, var(--primary) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: pulseGlow 1.5s ease-in-out infinite;
        }

        @keyframes spinPulse {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1); }
        }

        @keyframes pulseGlow {
            0%, 100% {
                opacity: 0.5;
                transform: translate(-50%, -50%) scale(0.8);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            overflow: visible;
            padding: 0;
        }

        .modal-content {
            background: linear-gradient(to bottom right, var(--dark), var(--secondary));
            width: 100%;
            height: 100%;
            margin: 0;
            border-radius: 0;
            overflow-y: auto;
            box-shadow: none;
        }

        .modal-header {
            padding: 1.5rem;
            background-color: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--accent);
        }

        .modal-body {
            padding: 1.5rem;
            display: flex;
            gap: 1.5rem;
        }

        .modal-poster {
            flex-shrink: 0;
            width: 300px;
            height: auto;
            border-radius: 10px;
        }

        .modal-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .modal-info h3 {
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .modal-overview {
            line-height: 1.7;
        }

        .watch-btn {
            background-color: var(--accent);
            color: white;
            padding: 1rem 2rem;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
            margin-top: 2rem;
        }

        .watch-btn:hover {
            background-color: #ff1a4f;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 46, 99, 0.4);
        }

        .trailer-btn {
            background-color: var(--primary);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 30px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            margin-top: 1rem;
        }

        .trailer-btn:hover {
            background-color: #00cc7a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 157, 0.3);
        }

        /* Trailer Modal Styles */
        .trailer-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .trailer-modal-content {
            background-color: var(--dark);
            width: 90%;
            max-width: 800px;
            height: 60%;
            max-height: 450px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .trailer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.7);
            border-bottom: 1px solid var(--primary);
        }

        .trailer-title {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-trailer {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-trailer:hover {
            color: var(--accent);
        }

        .trailer-video {
            width: 100%;
            height: calc(100% - 60px);
            border: none;
        }

        /* Mobile optimizations for trailer modal */
        @media (max-width: 768px) {
            .trailer-modal-content {
                width: 95%;
                height: 50%;
                max-height: 350px;
            }

            .trailer-header {
                padding: 0.5rem;
            }

            .trailer-title {
                font-size: 1rem;
            }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1.5rem;
                padding: 1.5rem;
            }

            .search-container {
                width: 100%;
                position: relative;
            }

            .search-box {
                width: 100%;
                font-size: 1rem;
                min-height: 48px; /* Better touch target */
                padding: 1rem;
            }

            .search-btn {
                min-height: 48px; /* Better touch target */
                padding: 1rem 1.5rem;
            }

            .search-suggestions {
                position: fixed;
                top: auto;
                left: 10px;
                right: 10px;
                border-radius: 10px;
                z-index: 1001;
                max-height: 200px;
            }

            .search-loading {
                right: 80px;
                font-size: 12px;
            }

            .hero {
                height: 50vh;
                padding: 2rem;
            }

            .hero h2 {
                font-size: 2rem;
            }

            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 1rem;
            }

            .content-card {
                height: 250px;
                flex-direction: column;
            }

            .modal-body {
                flex-direction: column;
                padding: 1rem;
            }
            .modal-header {
                padding: 1rem;
            }
            .modal-poster {
                width: 100%;
                max-width: 250px;
                align-self: center;
            }
        }

        @media (max-width: 768px) {
            .cast-crew-info {
                margin-top: 1.5rem;
                padding: 1.5rem;
            }

            .director-section h3, .cast-section h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            .director-profile {
                padding: 15px;
                gap: 15px;
            }

            .director-avatar {
                width: 80px;
                height: 80px;
            }

            .director-details h4 {
                font-size: 1.1rem;
            }

            .cast-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 15px;
            }

            .cast-profile {
                padding: 12px;
                gap: 12px;
            }

            .cast-avatar {
                width: 60px;
                height: 60px;
            }

            .cast-details h5 {
                font-size: 0.9rem;
            }

            .cast-character {
                font-size: 0.8rem;
                padding: 3px 8px;
            }
        }

        @media (max-width: 480px) {
            .hero h2 {
                font-size: 1.5rem;
            }

            .hero p {
                font-size: 1rem;
            }

            .content-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 0.8rem;
            }

            .content-card {
                height: 200px;
                flex-direction: column;
            }

            .card-title {
                font-size: 0.9rem;
            }

            .card-info {
                font-size: 0.8rem;
            }

            .cast-info {
                margin-top: 8px;
                padding: 8px 0;
            }

            .director-badge {
                font-size: 0.7rem;
                padding: 4px 8px;
            }

            .cast-members {
                gap: 8px;
            }

            .cast-label {
                font-size: 0.7rem;
                padding: 3px 6px;
            }

            .cast-member {
                padding: 4px 8px;
                gap: 6px;
            }

            .cast-member img {
                width: 28px;
                height: 28px;
            }

            .cast-member-name {
                font-size: 0.75rem;
            }

            .cast-crew-info {
                margin-top: 1rem;
                padding: 1rem;
            }

            .director-section h3, .cast-section h3 {
                font-size: 1.1rem;
                margin-bottom: 0.8rem;
            }

            .director-profile {
                flex-direction: column;
                text-align: center;
                padding: 12px;
                gap: 12px;
            }

            .director-avatar {
                width: 70px;
                height: 70px;
            }

            .director-details h4 {
                font-size: 1rem;
            }

            .director-role {
                font-size: 0.8rem;
                padding: 4px 10px;
            }

            .cast-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .cast-profile {
                padding: 10px;
                gap: 10px;
            }

            .cast-avatar {
                width: 50px;
                height: 50px;
            }

            .cast-details h5 {
                font-size: 0.85rem;
            }

            .cast-character {
                font-size: 0.75rem;
                padding: 2px 6px;
            }
        }

        footer {
            background-color: var(--dark);
            padding: 3rem 2rem;
            margin-top: 3rem;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .footer-section h3 {
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        .social-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .social-links a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            color: var(--text);
            transition: all 0.3s;
        }

        .social-links a:hover {
            background-color: var(--primary);
            color: var(--secondary);
            transform: translateY(-3px);
        }

        .copyright {
            text-align: center;
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        /* Video Modal Styles */
        .video-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 2000;
        }

        .video-modal-content {
            background-color: var(--dark);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .video-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.7);
            border-bottom: 1px solid var(--primary);
        }

        .video-title {
            color: var(--primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .provider-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .provider-btn-small {
            background-color: var(--secondary);
            color: var(--text);
            border: 1px solid var(--primary);
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .provider-btn-small:hover {
            background-color: var(--primary);
            color: var(--secondary);
        }

        .provider-btn-small.active {
            background-color: var(--primary);
            color: var(--secondary);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.5);
        }

        .video-quality {
            color: var(--primary);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .close-video {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-video:hover {
            color: var(--accent);
        }

        .video-player {
            flex: 1;
            position: relative;
            background-color: black;
            cursor: pointer;
        }

        .video-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--primary);
            font-size: 1.2rem;
            z-index: 10;
        }

        .video-loading i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .stream-iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* Custom Player Controls */
        .player-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            padding: 1rem;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 15;
        }

        .video-player:hover .player-controls {
            opacity: 1;
        }

        .controls-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .controls-bottom {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .play-pause-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .play-pause-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .progress-container {
            flex: 1;
            position: relative;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
            margin: 0 1rem;
        }

        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }

        .time-display {
            color: white;
            font-size: 0.9rem;
            min-width: 80px;
            text-align: center;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .volume-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .volume-slider {
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            cursor: pointer;
            position: relative;
        }

        .volume-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
            width: 70%;
        }

        .fullscreen-btn, .pip-btn, .next-episode-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .fullscreen-btn:hover, .pip-btn:hover, .next-episode-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .next-episode-btn {
            display: none;
        }

        .tv-mode .next-episode-btn {
            display: block;
        }

        /* Mobile optimizations for video modal */
        @media (max-width: 768px) {
            .video-header {
                flex-direction: column;
                gap: 1rem;
                padding: 0.5rem;
            }

            .provider-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }

            .provider-btn-small {
                font-size: 0.7rem;
                padding: 0.2rem 0.4rem;
            }
        }
    </style>
</head>
<body>
    <div id="root">
    <header>
        <nav class="navbar">
            <div class="logo">
                <h1><i class="fas fa-play-circle" aria-hidden="true"></i> StreamFlix</h1>
            </div>
            <div class="search-container">
                <input type="text" class="search-box" id="searchInput" placeholder="🔍 Search movies, TV shows, actors, genres...">
                <button class="search-btn" id="searchBtn"><i class="fas fa-search" aria-hidden="true"></i> Search</button>
            </div>
        </nav>
    </header>

    <div class="container">
        <section class="hero">
            <div class="hero-content">
                <h2 id="heroTitle">Unlimited Entertainment</h2>
                <p id="heroDesc">Stream thousands of movies and TV shows in HD quality. Anytime, anywhere.</p>
                <div class="hero-btns">
                    <button class="btn btn-primary" id="startWatchingBtn"><i class="fas fa-play" aria-hidden="true"></i> Start Watching</button>
                    <button class="btn btn-secondary" id="moreInfoBtn"><i class="fas fa-info-circle" aria-hidden="true"></i> More Info</button>
                </div>
                <div class="hero-status" id="heroStatus"></div>
            </div>
        </section>

        <div class="main-content">
            <aside class="categories-sidebar">
                <div class="categories-header">
                    <h3><i class="fas fa-compass" aria-hidden="true"></i> Explore</h3>
                </div>

                <div class="mode-toggle">
                    <button class="mode-btn active" id="movieMode">Movies</button>
                    <button class="mode-btn" id="tvMode">TV Shows</button>
                </div>

                <div class="categories-section">
                    <h4><i class="fas fa-film" aria-hidden="true"></i> Movie Genres</h4>
                    <div class="category-list" id="movieCategories">
                        <!-- Movie categories will be loaded here -->
                    </div>
                </div>

                <div class="categories-section">
                    <h4><i class="fas fa-tv" aria-hidden="true"></i> TV Show Genres</h4>
                    <div class="category-list" id="tvCategories">
                        <!-- TV categories will be loaded here -->
                    </div>
                </div>

                <div class="categories-section">
                    <h4><i class="fas fa-calendar-alt" aria-hidden="true"></i> By Year</h4>
                    <div class="year-list" id="yearCategories">
                        <!-- Year categories will be loaded here -->
                    </div>
                </div>
            </aside>

            <main class="content-grid-wrapper" style="flex: 1;">
                <h2 class="section-title"><i class="fas fa-fire" aria-hidden="true"></i> Popular Now</h2>

                <div class="content-grid" id="contentGrid">
                    <!-- Content will be loaded here -->
                </div>

                <div class="loading" id="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading content...</p>
                </div>
            </main>
        </div>

        <button class="btn btn-secondary" id="loadMore" style="display: none; margin: 0 auto;">Load More</button>
    </div>

    <!-- Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Movie Title</h2>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div>
                    <img src="" alt="Poster" class="modal-poster" id="modalPoster">
                </div>
                <div class="modal-details">
                    <div class="modal-info">
                        <h3>Details</h3>
                        <p><strong>Release Date:</strong> <span id="modalDate"></span></p>
                        <p><strong>Rating:</strong> <span id="modalRating"></span></p>
                        <p><strong>Language:</strong> <span id="modalLanguage"></span></p>
                        <p><strong>Runtime:</strong> <span id="modalRuntime"></span></p>
                        <p><strong>Genres:</strong> <span id="modalGenres"></span></p>
                        <p><strong>Director:</strong> <span id="modalDirector"></span></p>
                    </div>
                    <div class="modal-overview">
                        <h3>Overview</h3>
                        <p id="modalOverview">No overview available.</p>
                        <button class="watch-btn" id="watchBtn"><i class="fas fa-play" aria-hidden="true"></i> Watch Now</button>
                        <button class="trailer-btn" id="trailerBtn" style="display: none;"><i class="fas fa-film" aria-hidden="true"></i> Watch Trailer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </div>

    <!-- Trailer Modal -->
    <div class="trailer-modal" id="trailerModal">
        <div class="trailer-modal-content">
            <div class="trailer-header">
                <h3 class="trailer-title" id="trailerTitle">Trailer</h3>
                <button class="close-trailer" id="closeTrailer">&times;</button>
            </div>
            <iframe class="trailer-video" id="trailerVideo" src="" allow="fullscreen"></iframe>
        </div>
    </div>

    <script>
        // Configuration
        const IMG_URL = 'https://image.tmdb.org/t/p/w500';
        const API_URL = 'https://streamflix.22afed28-f0b2-46d0-8804-c90e25c90bd4.workers.dev';

        // State variables
        let currentPage = 1;
        let currentQuery = '';
        let isFetching = false;
        let currentMode = 'movie';
        let currentItem = null;
        let currentHeroIndex = 0;

        // Initialize filter state variables
        window.lastGenreFilter = null;
        window.lastYearFilter = null;

        // DOM Elements
        const contentGrid = document.getElementById('contentGrid');
        const loadingElement = document.getElementById('loading');
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const movieModeBtn = document.getElementById('movieMode');
        const tvModeBtn = document.getElementById('tvMode');
        const loadMoreBtn = document.getElementById('loadMore');
        const detailModal = document.getElementById('detailModal');
        const closeModal = document.getElementById('closeModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalPoster = document.getElementById('modalPoster');
        const modalDate = document.getElementById('modalDate');
        const modalRating = document.getElementById('modalRating');
        const modalLanguage = document.getElementById('modalLanguage');
        const modalRuntime = document.getElementById('modalRuntime');
        const modalGenres = document.getElementById('modalGenres');
        const modalDirector = document.getElementById('modalDirector');
        const modalOverview = document.getElementById('modalOverview');
        const watchBtn = document.getElementById('watchBtn');
        const trailerBtn = document.getElementById('trailerBtn');
        const closeTrailer = document.getElementById('closeTrailer');
        const trailerModal = document.getElementById('trailerModal');
        const trailerVideo = document.getElementById('trailerVideo');
        const trailerTitle = document.getElementById('trailerTitle');
        const startWatchingBtn = document.getElementById('startWatchingBtn');
        const moreInfoBtn = document.getElementById('moreInfoBtn');

        // Hero slideshow state
        let heroMovies = [];
        let slideshowInterval = null;
        let isPaused = false;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            fetchContent();
            fetchHeroMovies();
            setupEventListeners();
            addSearchEnhancements();
            loadCategories();
            initializeImageLoading();

            // Set interval to refetch hero movies every 5 minutes
            setInterval(fetchHeroMovies, 5 * 60 * 1000);

            // Start the slideshow after hero movies are loaded with proper delay
            const startSlideshow = () => {
                if (heroMovies.length > 0) {
                    startHeroSlideshow();
                } else {
                    setTimeout(startSlideshow, 1000);
                }
            };

            // Wait for hero movies to load before starting slideshow
            setTimeout(startSlideshow, 2000);

            // Add a function to refresh all cast information
            window.refreshAllCastInfo = refreshAllCastInfo;

            // Add console commands for debugging
            window.debugCast = {
                refreshAll: refreshAllCastInfo,
                testData: () => console.log('Test cast data:', window.testCastData),
                checkAPI: () => console.log('API URL:', API_URL)
            };

            // Add hero slideshow debugging commands
            window.debugHero = {
                sync: syncButtonsWithDisplay,
                refresh: refreshButtonStates,
                getCurrent: getCurrentDisplayedMovie,
                checkState: () => {
                    console.log('Hero Debug Info:');
                    console.log('- Total movies:', heroMovies.length);
                    console.log('- Current index:', currentHeroIndex);
                    console.log('- Current displayed:', currentDisplayedMovie?.title, 'ID:', currentDisplayedMovie?.id);
                    console.log('- Is slideshow running:', slideshowInterval !== null);
                    console.log('- Is paused:', isPaused);
                    console.log('- Next update in:', slideshowInterval ? '8 seconds' : 'N/A');
                },
                forceUpdate: () => {
                    console.log('Force updating hero display...');
                    updateHero();
                },
                resetIndex: () => {
                    currentHeroIndex = 0;
                    currentDisplayedMovie = heroMovies.length > 0 ? heroMovies[0] : null;
                    console.log('Hero index reset to 0');
                },
                testButtons: () => {
                    console.log('Testing hero buttons...');
                    // This is a reference to a function that is defined later in the code
                    const currentMovie = getCurrentDisplayedMovie();
                    if (currentMovie) {
                        console.log('✅ More Info button should show details for:', currentMovie.title);
                        console.log('✅ Start Watching button should play:', currentMovie.title);
                        console.log('✅ Movie ID for API calls:', currentMovie.id);
                    } else {
                        console.log('❌ No current movie available for buttons');
                    }
                }
            };

        });

        // Initialize enhanced image loading system
        function initializeImageLoading() {
            console.log('Initializing enhanced image loading system...');

            // Load all images that are currently in view
            loadVisibleImages();

            // Set up intersection observer for lazy loading
            setupLazyLoading();

            // Load images in cast containers when they become visible
            observeCastContainers();
        }

        function loadVisibleImages() {
            const images = document.querySelectorAll('img[data-src]');
            const visibleImages = Array.from(images).filter(img => {
                return img.offsetParent !== null && !img.hasAttribute('data-loaded');
            });

            if (visibleImages.length > 0) {
                console.log(`Loading ${visibleImages.length} visible images...`);
                loadImagesBatch(visibleImages).then(results => {
                    console.log('Image loading completed:', results);
                });
            }
        }

        function setupLazyLoading() {
            if ('IntersectionObserver' in window) {
                const imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.hasAttribute('data-src') && !img.hasAttribute('data-loaded')) {
                                const src = img.getAttribute('data-src');
                                const fallbackSrc = img.getAttribute('data-fallback');

                                loadImageWithFallback(img, src, fallbackSrc).then(() => {
                                    img.setAttribute('data-loaded', 'true');
                                    observer.unobserve(img);
                                });
                            }
                        }
                    });
                }, {
                    rootMargin: '50px 0px',
                    threshold: 0.1
                });

                // Observe all images with data-src
                document.querySelectorAll('img[data-src]').forEach(img => {
                    imageObserver.observe(img);
                });
            } else {
                // Fallback for browsers without IntersectionObserver
                document.querySelectorAll('img[data-src]').forEach(img => {
                    const src = img.getAttribute('data-src');
                    const fallbackSrc = img.getAttribute('data-fallback');
                    loadImageWithFallback(img, src, fallbackSrc).then(() => {
                        img.setAttribute('data-loaded', 'true');
                    });
                });
            }
        }

        function observeCastContainers() {
            const castContainers = document.querySelectorAll('[id^="cast-"]');
            if (castContainers.length === 0) return;

            const containerObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const container = entry.target;
                        const images = container.querySelectorAll('img[data-src]:not([data-loaded])');

                        if (images.length > 0) {
                            loadImagesBatch(images).then(() => {
                                images.forEach(img => img.setAttribute('data-loaded', 'true'));
                            });
                        }

                        containerObserver.unobserve(container);
                    }
                });
            }, { threshold: 0.1 });

            castContainers.forEach(container => {
                containerObserver.observe(container);
            });
        }

        // Function to refresh all cast information for visible cards
        function refreshAllCastInfo() {
            console.log('Refreshing all cast information...');
            const castContainers = document.querySelectorAll('[id^="cast-"]');

            castContainers.forEach(container => {
                const itemId = container.id.replace('cast-', '');
                const cards = document.querySelectorAll('.content-card');

                cards.forEach(card => {
                    const watchBtn = card.querySelector('.watch-btn-card');
                    if (watchBtn && watchBtn.getAttribute('data-item-id') == itemId) {
                        const item = {
                            id: parseInt(itemId),
                            type: (card.querySelector('.type-badge')?.textContent === 'TV Show') ? 'tv' : 'movie'
                        };

                        if (item.id && item.type) {
                            console.log('Refreshing cast for item:', item);
                            // Reset the container
                            container.innerHTML = `
                                <div class="cast-loading" style="display: flex; align-items: center; gap: 8px; color: #999; font-size: 0.75rem;">
                                    <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                                    <span>Loading cast & crew...</span>
                                </div>
                            `;
                            // Reload cast info
                            loadCastInfo(item.id, item.type);
                        }
                    }
                });
            });
        }

        // Load and populate categories
        async function loadCategories() {
            try {
                const [movieGenresRes, tvGenresRes, popularMoviesRes, popularTvsRes] = await Promise.all([
                    fetch(`${API_URL}/genre/movie/list`),
                    fetch(`${API_URL}/genre/tv/list`),
                    fetch(`${API_URL}/movie/popular?page=1`), // For year population
                    fetch(`${API_URL}/tv/popular?page=1`)      // For year population
                ]);

                const [movieGenresData, tvGenresData, popularMoviesData, popularTvsData] = await Promise.all([
                    movieGenresRes.json(),
                    tvGenresRes.json(),
                    popularMoviesRes.json(),
                    popularTvsRes.json()
                ]);

                if (movieGenresData.genres) {
                    populateMovieCategories(movieGenresData.genres);
                }
                if (tvGenresData.genres) {
                    populateTVCategories(tvGenresData.genres);
                }

                populateYearCategories([...popularMoviesData.results, ...popularTvsData.results]);

                attachCategoryEventListeners();

                console.log('Categories populated successfully');

            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function populateMovieCategories(genres) {
            const container = document.getElementById('movieCategories');
            if (!container) return;

            container.innerHTML = '';

            genres.forEach(genre => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.setAttribute('data-genre-id', genre.id);
                categoryItem.setAttribute('data-genre-type', 'movie');
                categoryItem.innerHTML = `<span>${genre.name}</span>`;

                categoryItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const clickedGenreId = this.getAttribute('data-genre-id');
                    const clickedType = this.getAttribute('data-genre-type');
                    filterByGenre(parseInt(clickedGenreId), clickedType, e);
                });

                container.appendChild(categoryItem);
            });
        }

        function populateTVCategories(genres) {
            const container = document.getElementById('tvCategories');
            if (!container) return;

            container.innerHTML = '';

            genres.forEach(genre => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.setAttribute('data-genre-id', genre.id);
                categoryItem.setAttribute('data-genre-type', 'tv');
                categoryItem.innerHTML = `<span>${genre.name}</span>`;

                categoryItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const clickedGenreId = this.getAttribute('data-genre-id');
                    const clickedType = this.getAttribute('data-genre-type');
                    filterByGenre(parseInt(clickedGenreId), clickedType, e);
                });

                container.appendChild(categoryItem);
            });
        }

        function populateYearCategories(items) {
            const container = document.getElementById('yearCategories');
            if (!container) return;

            // Get unique years
            const years = new Map();

            items.forEach(item => {
                const date = item.release_date || item.first_air_date;
                if (date) {
                    const year = new Date(date).getFullYear().toString();
                    if (!years.has(year)) {
                        years.set(year, 0);
                    }
                    years.set(year, years.get(year) + 1);
                }
            });

            container.innerHTML = '';

            Array.from(years.entries())
                .sort((a, b) => b[0] - a[0]) // Sort by year descending
                .slice(0, 15) // Show last 15 years
                .forEach(([year, count]) => {
                    const yearItem = document.createElement('div');
                    yearItem.className = 'year-item';
                    yearItem.setAttribute('data-year', year);
                    yearItem.innerHTML = `
                        <span>${year}</span>
                        <span class="year-count">${count}</span>
                    `;

                    // Add click event listener with proper context
                    yearItem.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const clickedYear = this.getAttribute('data-year');
                        console.log('Year clicked:', clickedYear);
                        filterByYear(clickedYear);
                    });

                    container.appendChild(yearItem);
                });
        }

        function filterByGenre(genreId, type, event) {
            console.log('Filtering by genre:', genreId, 'Type:', type);

            // Remove active class from all categories
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to clicked category
            if (event && event.currentTarget) {
                const clickedItem = event.currentTarget;
                if (clickedItem) {
                    clickedItem.classList.add('active');
                }
            }

            // Filter content by genre
            performGenreFilter(genreId, type);
        }

        // Clear the main content grid before displaying new results
        contentGrid.innerHTML = '';

        function filterByYear(year, event = null) {
            console.log('Filtering by year:', year);

            // Remove active class from all years
            document.querySelectorAll('.year-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked year if event is provided
            if (event && event.target) {
                const clickedItem = event.target.closest('.year-item');
                if (clickedItem) {
                    clickedItem.classList.add('active');
                }
            }

            // Filter content by year
            performYearFilter(year);
        }

        async function performGenreFilter(genreId, type) {
            // Store the last action for retry functionality
            window.lastGenreFilter = { genreId, type };

            // Set the current mode to match the filter type
            currentMode = type;

            try {
                console.log('Performing genre filter:', { genreId, type });
                showSearchLoading(true);

                let endpoint;
                if (type === 'movie') {
                    endpoint = `${API_URL}/discover/movie?with_genres=${genreId}&page=1`;
                } else {
                    endpoint = `${API_URL}/discover/tv?with_genres=${genreId}&page=1`;
                }

                console.log('Genre filter endpoint:', endpoint);
                const response = await fetch(endpoint);

                if (!response.ok) {
                    console.error('API Error:', response.status, response.statusText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Genre filter results:', data.results ? data.results.length : 'No results', data);

                if (!data.results || data.results.length === 0) {
                    console.warn('No results returned from API for genre filter');
                    contentGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #ccc; background: var(--dark); border-radius: 15px;">
                            <i class="fas fa-search" style="font-size: 64px; color: var(--primary); margin-bottom: 30px;"></i>
                            <h3 style="font-size: 1.5rem; margin-bottom: 15px;">No ${type === 'movie' ? 'movies' : 'TV shows'} found</h3>
                            <p style="font-size: 1.1rem;">This genre might not have content available at the moment.</p>
                        </div>
                    `;
                    updateSearchResultsCounter(0);
                } else {
                    displayContent(data.results);
                    updateSearchResultsCounter(data.results.length);
                }

                showSearchLoading(false);

            } catch (error) {
                console.error('Error filtering by genre:', error);
                showSearchLoading(false);

                // Show a more user-friendly error message
                contentGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #ccc; background: var(--dark); border-radius: 15px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: var(--accent); margin-bottom: 30px;" aria-hidden="true"></i>
                        <h3 style="font-size: 1.5rem; margin-bottom: 15px;">Unable to filter by genre</h3>
                        <p style="font-size: 1.1rem; margin-bottom: 20px;">${error.message}</p>
                        <button onclick="retryLastAction()" class="btn btn-primary">Try Again</button>
                    </div>
                `;
                updateSearchResultsCounter(0);
            }
        }

        // Function to retry the last action
        function retryLastAction() {
            if (window.lastGenreFilter) {
                performGenreFilter(window.lastGenreFilter.genreId, window.lastGenreFilter.type);
            } else if (window.lastYearFilter) {
                performYearFilter(window.lastYearFilter);
            }
        }

        async function performYearFilter(year) {
            // Store the last action for retry functionality
            window.lastYearFilter = year;

            try {
                showSearchLoading(true);

                const [movieResponse, tvResponse] = await Promise.all([
                    fetch(`${API_URL}/discover/movie?primary_release_year=${year}&page=1`),
                    fetch(`${API_URL}/discover/tv?first_air_date.gte=${year}-01-01&first_air_date.lte=${year}-12-31&page=1`)
                ]);

                const [movieData, tvData] = await Promise.all([
                    movieResponse.json(),
                    tvResponse.json()
                ]);

                const combinedResults = [...movieData.results, ...tvData.results];
                displayContent(combinedResults);
                updateSearchResultsCounter(combinedResults.length);
                showSearchLoading(false);

            } catch (error) {
                console.error('Error filtering by year:', error);
                showSearchLoading(false);
            }
        }

        function addSearchEnhancements() {
            // Add search hint
            const searchContainer = document.querySelector('.search-container');
            const hint = document.createElement('small');
            hint.textContent = '💡 Tip: Try searching for movie titles, actors, or genres!';
            hint.style.cssText = `
                display: block;
                color: rgba(255,255,255,0.6);
                font-size: 0.8rem;
                margin-top: 8px;
                text-align: center;
            `;
            searchContainer.appendChild(hint);

            // Add refresh cast info button (hidden by default, can be enabled for debugging)
            const refreshBtn = document.createElement('button');
            refreshBtn.innerHTML = '<i class="fas fa-sync" aria-hidden="true"></i> Refresh Cast Info';
            refreshBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--primary);
                color: var(--secondary);
                border: none;
                padding: 10px 15px;
                border-radius: 25px;
                cursor: pointer;
                font-size: 0.8rem;
                z-index: 1000;
                display: none; /* Hidden by default, can be enabled for debugging */
                box-shadow: 0 4px 15px rgba(0,255,157,0.3);
            `;
            refreshBtn.onclick = refreshAllCastInfo;
            document.body.appendChild(refreshBtn);

            // Add keyboard shortcut hint for search focus
            document.addEventListener('keydown', (e) => {
                if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey && document.activeElement !== searchInput) {
                    e.preventDefault();
                    searchInput.focus();
                }
            });

            // Add search examples for testing
            addSearchTestData();
        }

        function addSearchTestData() {
            // Add some popular titles to help with testing
            const testData = [
                {
                    id: 999999,
                    title: 'All of Us Are Dead',
                    name: 'All of Us Are Dead',
                    type: 'tv',
                    overview: 'A high school becomes ground zero for a zombie virus outbreak. Trapped students must fight their way out or turn into one of the rabid infected.',
                    vote_average: 8.5,
                    first_air_date: '2022-01-28',
                    poster_path: '/nHf61UzkfFno5X1ofIhugCPus2R.jpg',
                    genre_ids: [18, 10759, 10765]
                },
                {
                    id: 999998,
                    title: 'Squid Game',
                    name: 'Squid Game',
                    type: 'tv',
                    overview: 'Hundreds of cash-strapped players accept a strange invitation to compete in children\'s games for a tempting prize, but the stakes are deadly.',
                    vote_average: 8.0,
                    first_air_date: '2021-09-17',
                    poster_path: '/dDlEmu3EZCsQQeTSUmRj0kDRMj.jpg',
                    genre_ids: [18, 10759, 9648]
                }
            ];

            // Store test data for search
            window.testSearchData = testData;

            // Add comprehensive test cast/crew data with real TMDB-style paths
            window.testCastData = {
                999999: { // All of Us Are Dead
                    cast: [
                        {
                            name: 'Park Ji-hu',
                            character: 'Nam On-jo',
                            profile_path: '/sJiNBBmL4a1s0hmnoUuLJ5o1t.jpg'
                        },
                        {
                            name: 'Yoon Chan-young',
                            character: 'Lee Cheong-san',
                            profile_path: '/p0KHZ0eVQRGKvnlHHaqK8ujjK.jpg'
                        },
                        {
                            name: 'Cho Yi-hyun',
                            character: 'Choi Nam-ra',
                            profile_path: '/aKzqFNKP2G0YhZq9lGEKwiw.jpg'
                        },
                        {
                            name: 'Lomon',
                            character: 'Lee Su-hyeok',
                            profile_path: '/mVzRUeKxM2wJ5n8oXhH7R.jpg'
                        },
                        {
                            name: 'Yoo In-soo',
                            character: 'Yoon Gwi-nam',
                            profile_path: '/kU1n4EjL.jpg'
                        },
                        {
                            name: 'Lee Yoo-mi',
                            character: 'Lee Na-yeon',
                            profile_path: '/p0KHZ0eVQRGKvnlHHaqK8ujjK.jpg'
                        }
                    ],
                    crew: [
                        {
                            name: 'Lee Jae-kyoo',
                            job: 'Director',
                            profile_path: '/director1.jpg'
                        },
                        {
                            name: 'Kim Nam-su',
                            job: 'Director',
                            profile_path: '/director2.jpg'
                        }
                    ]
                },
                999998: { // Squid Game
                    cast: [
                        {
                            name: 'Lee Jung-jae',
                            character: 'Seong Gi-hun',
                            profile_path: '/lldeG4Co5MSJJpiUkkJjTITPc5.jpg'
                        },
                        {
                            name: 'Park Hae-soo',
                            character: 'Cho Sang-woo',
                            profile_path: '/p0KHZ0eVQRGKvnlHHaqK8ujjK.jpg'
                        },
                        {
                            name: 'Wi Ha-jun',
                            character: 'Hwang Jun-ho',
                            profile_path: '/mVzRUeKxM2wJ5n8oXhH7R.jpg'
                        },
                        {
                            name: 'HoYeon Jung',
                            character: 'Kang Sae-byeok',
                            profile_path: '/kU1n4EjL.jpg'
                        },
                        {
                            name: 'O Yeong-su',
                            character: 'Oh Il-nam',
                            profile_path: '/p0KHZ0eVQRGKvnlHHaqK8ujjK.jpg'
                        },
                        {
                            name: 'Heo Sung-tae',
                            character: 'Jang Deok-su',
                            profile_path: '/aKzqFNKP2G0YhZq9lGEKwiw.jpg'
                        }
                    ],
                    crew: [
                        {
                            name: 'Hwang Dong-hyuk',
                            job: 'Director',
                            profile_path: '/director2.jpg'
                        }
                    ]
                }
            };
        }

        // Set up event listeners
        function setupEventListeners() {
            searchBtn.addEventListener('click', handleSearch);
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();

                // Add typing animation effect
                if (query.length > 0 && query.length <= 3) {
                    addTypingEffect();
                } else {
                    removeTypingEffect();
                }

                // Show results immediately for every keystroke if query length > 0
                if (query.length > 0) {
                    showLiveSearchResults(query);
                } else {
                    hideLiveSearchResults();
                    hideSearchSuggestions();
                    removeTypingEffect();
                    // Show default content when search is cleared
                    currentQuery = '';
                    currentPage = 1;
                    contentGrid.innerHTML = '';
                    fetchContent();
                }
            });

            searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSearch();
                }
            });

            // Hide live results when clicking outside
            searchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    hideLiveSearchResults();
                    hideSearchSuggestions();
                }, 200);
            });

            searchInput.addEventListener('focus', () => {
                const query = searchInput.value.trim();

                // Add focus glow effect
                searchInput.style.boxShadow = `
                    0 0 20px rgba(0, 255, 157, 0.4),
                    0 0 40px rgba(0, 255, 157, 0.2),
                    inset 0 0 20px rgba(0, 255, 157, 0.1)
                `;

                // Add breathing animation to search container
                const searchContainer = searchInput.parentNode;
                searchContainer.style.animation = 'breathe 2s ease-in-out infinite';

                if (query.length > 0) {
                    showLiveSearchResults(query);
                }
            });

            searchInput.addEventListener('blur', () => {
                // Remove focus effects after a short delay
                setTimeout(() => {
                    searchInput.style.boxShadow = '';

                    // Remove breathing animation
                    const searchContainer = searchInput.parentNode;
                    searchContainer.style.animation = '';

                    removeTypingEffect();
                }, 200);

                setTimeout(() => {
                    hideLiveSearchResults();
                    hideSearchSuggestions();
                }, 200);
            });

            movieModeBtn.addEventListener('click', () => switchMode('movie'));
            tvModeBtn.addEventListener('click', () => switchMode('tv'));

            loadMoreBtn.addEventListener('click', loadMore);
            closeModal.addEventListener('click', () => detailModal.style.display = 'none');

            // Close modals when clicking outside
            detailModal.addEventListener('click', (e) => {
                if (e.target === detailModal) {
                    detailModal.style.display = 'none';
                }
            });

            trailerModal.addEventListener('click', (e) => {
                if (e.target === trailerModal) {
                    trailerModal.style.display = 'none';
                    trailerVideo.src = '';
                }
            });

            closeTrailer.addEventListener('click', () => {
                trailerModal.style.display = 'none';
                trailerVideo.src = '';
            });

            // Watch button in modal
            watchBtn.addEventListener('click', () => {
                playVideo(currentItem);
            });

            // More Info button - show details for current hero movie
            moreInfoBtn.addEventListener('click', () => {
                console.log('More Info button clicked');
                console.log('Hero movies:', heroMovies.length);
                console.log('Current hero index:', currentHeroIndex);
                console.log('Current displayed movie:', currentDisplayedMovie?.title);

                const currentMovie = getCurrentDisplayedMovie();

                if (currentMovie && currentMovie.id) {
                    currentMode = 'movie'; // Set mode to movie for hero content
                    showDetails(currentMovie.id);
                } else {
                    // This is a reference to a variable that is defined later in the code
                    console.error('Current movie or movie ID is missing');
                    console.log('Available movies:', heroMovies.length);
                    console.log('Current displayed movie:', currentDisplayedMovie);
                    alert('Movie information not available. Please wait for content to load or refresh the page.');
                }
            });

            // Start Watching button - play current hero movie
            startWatchingBtn.addEventListener('click', () => {
                console.log('Start Watching button clicked');
                console.log('Hero movies:', heroMovies.length);
                console.log('Current hero index:', currentHeroIndex);
                console.log('Current displayed movie:', currentDisplayedMovie?.title);

                const currentMovie = getCurrentDisplayedMovie();

                if (currentMovie && currentMovie.id) {
                    currentMode = 'movie'; // Set mode to movie for hero content
                    currentItem = currentMovie;
                    playVideo(currentMovie);
                } else {
                    console.error('Current movie or movie ID is missing');
                    console.log('Available movies:', heroMovies.length);
                    console.log('Current displayed movie:', currentDisplayedMovie);
                    alert('Movie information not available. Please wait for content to load or refresh the page.');
                }
            });
        }

        // Handle search
        function handleSearch() {
            const query = searchInput.value.trim();
            if (query) {
                currentQuery = query;
                currentPage = 1;
                hideLiveSearchResults();
                hideSearchSuggestions();
                // Replace main content with search results
                performFullSearch(query);
            }
        }

        async function performFullSearch(query) {
            showSearchLoading(true);

            try {
                // First try to get results from popular content
                let allItems = await fetchAllContentForSearch();

                // If we don't have enough results or the specific movie isn't found,
                // try direct TMDB search
                if (allItems.length < 50 || !containsMatchingTitle(allItems, query)) {
                    const directResults = await directTMDBSearch(query);
                    if (directResults.length > 0) {
                        allItems = [...directResults, ...allItems];
                    }
                }

                const searchResults = allItems.map(item => {
                    const score = calculateRelevanceScore(item, query);
                    return { item, score };
                }).filter(result => result.score > 0)
                  .sort((a, b) => b.score - a.score)
                  .slice(0, 20) // Show more results in full search
                  .map(result => result.item);

                displayContent(searchResults);
                updateSearchResultsCounter(searchResults.length);
                showSearchLoading(false);
            } catch (error) {
                console.error('Error in full search:', error);
                showSearchLoading(false);
            }
        }

        function containsMatchingTitle(items, query) {
            const queryLower = query.toLowerCase();
            return items.some(item => {
                const title = (item.title || item.name || '').toLowerCase();
                const originalTitle = (item.original_title || item.original_name || '').toLowerCase();
                return title.includes(queryLower) || originalTitle.includes(queryLower);
            });
        }

        async function directTMDBSearch(query) {
            const results = [];

            try {
                const [movieResponse, tvResponse] = await Promise.all([
                    fetch(`${API_URL}/search/movie?query=${encodeURIComponent(query)}&page=1`),
                    fetch(`${API_URL}/search/tv?query=${encodeURIComponent(query)}&page=1`)
                ]);

                const [movieData, tvData] = await Promise.all([
                    movieResponse.json(),
                    tvResponse.json()
                ]);

                // Add type to items
                const movies = movieData.results.map(item => ({ ...item, type: 'movie' }));
                const tvShows = tvData.results.map(item => ({ ...item, type: 'tv' }));

                results.push(...movies, ...tvShows);

                console.log(`Direct search found ${results.length} results for "${query}"`);

            } catch (error) {
                console.error('Error in direct TMDB search:', error);
            }

            return results;
        }

        // Enhanced search with fuzzy matching and relevance scoring
        function performAdvancedSearch(query) {
            const searchTerm = query.toLowerCase().trim();

            if (!searchTerm) {
                fetchContent();
                hideSearchSuggestions();
                return;
            }

            showSearchLoading(true);

            // Use requestAnimationFrame for better performance
            requestAnimationFrame(async () => {
                try {
                    const allItems = await fetchAllContentForSearch();
                    const searchResults = allItems.map(item => {
                        const score = calculateRelevanceScore(item, searchTerm);
                        return { item, score };
                    }).filter(result => result.score > 0)
                      .sort((a, b) => b.score - a.score)
                      .slice(0, 50)
                      .map(result => result.item);

                    displayContent(searchResults);
                    showSearchSuggestions(searchTerm, allItems);
                    showSearchLoading(false);
                    updateSearchResultsCounter(searchResults.length);
                } catch (error) {
                    console.error('Error in advanced search:', error);
                    showSearchLoading(false);
                }
            });
        }

        async function fetchAllContentForSearch() {
            const allItems = [];

            try {
                // Fetch more pages for better search coverage
                const pagesToFetch = 3; // Fetch first 3 pages for more results
                const fetchPromises = [];

                // Fetch multiple pages of movies and TV shows
                for (let page = 1; page <= pagesToFetch; page++) {
                    fetchPromises.push(
                        fetch(`${API_URL}/movie/popular?page=${page}`).then(res => res.json()),
                        fetch(`${API_URL}/tv/popular?page=${page}`).then(res => res.json())
                    );
                }

                const responses = await Promise.all(fetchPromises);

                // Process all responses
                for (let i = 0; i < responses.length; i += 2) {
                    const movieData = responses[i];
                    const tvData = responses[i + 1];

                    // Add type to items for easier identification
                    const movies = movieData.results.map(item => ({ ...item, type: 'movie' }));
                    const tvShows = tvData.results.map(item => ({ ...item, type: 'tv' }));

                    allItems.push(...movies, ...tvShows);
                }

                // Remove duplicates based on ID
                const uniqueItems = allItems.filter((item, index, self) =>
                    index === self.findIndex(t => t.id === item.id)
                );

                // Add test data for popular titles that might not be in the API
                if (window.testSearchData) {
                    uniqueItems.push(...window.testSearchData);
                }

                console.log(`Loaded ${uniqueItems.length} items for search`);
                return uniqueItems;

            } catch (error) {
                console.error('Error fetching content for search:', error);

                // Fallback: try to search TMDB directly for the specific query
                return await fallbackSearch();
            }
        }

        async function fallbackSearch() {
            const allItems = [];

            try {
                // If main search fails, try direct TMDB search
                const searchQuery = searchInput.value.trim();
                if (searchQuery.length >= 3) {
                    const [movieResponse, tvResponse] = await Promise.all([
                        fetch(`${API_URL}/search/movie?query=${encodeURIComponent(searchQuery)}&page=1`),
                        fetch(`${API_URL}/search/tv?query=${encodeURIComponent(searchQuery)}&page=1`)
                    ]);

                    const [movieData, tvData] = await Promise.all([
                        movieResponse.json(),
                        tvResponse.json()
                    ]);

                    const movies = movieData.results.map(item => ({ ...item, type: 'movie' }));
                    const tvShows = tvData.results.map(item => ({ ...item, type: 'tv' }));

                    allItems.push(...movies, ...tvShows);
                }
            } catch (error) {
                console.error('Fallback search also failed:', error);
            }

            return allItems;
        }

        function calculateRelevanceScore(item, searchTerm) {
            let score = 0;
            const terms = searchTerm.split(' ').filter(term => term.length > 0);

            // Search in multiple fields with different weights
            const title = (item.title || item.name || '').toLowerCase();
            const overview = (item.overview || '').toLowerCase();
            const originalTitle = (item.original_title || item.original_name || '').toLowerCase();

            terms.forEach(term => {
                // Exact title match gets highest score (including original titles)
                if (title === term) score += 1000;
                else if (originalTitle === term) score += 1000;
                else if (title.includes(term) && title.indexOf(term) === 0) score += 800; // Starts with term
                else if (title.includes(term)) score += 200;
                else if (originalTitle.includes(term)) score += 200;

                // Overview matches
                if (overview.includes(term)) score += 50;

                // More flexible partial matching for each word
                const titleWords = title.split(' ');
                const originalTitleWords = originalTitle.split(' ');
                const allWords = [...titleWords, ...originalTitleWords];

                allWords.forEach(word => {
                    if (word.length >= 2 && term.length >= 2) {
                        // Exact word match
                        if (word === term) score += 400;
                        // Word starts with search term
                        else if (word.startsWith(term)) score += 200;
                        // Word contains search term
                        else if (word.includes(term)) score += 100;
                        // Search term contains word (reverse matching)
                        else if (term.includes(word)) score += 80;
                        // Character-by-character fuzzy matching
                        else {
                            const similarity = calculateSimilarity(word, term);
                            if (similarity > 0.6) score += Math.floor(similarity * 150);
                        }
                    }
                });

                // Special handling for Korean/Asian titles
                if (containsAsianCharacters(term)) {
                    // For Asian titles, be more lenient with matching
                    if (title.includes(term) || originalTitle.includes(term)) {
                        score += 300;
                    }
                }

                // Fuzzy character matching (more lenient)
                const fuzzyMatches = fuzzyMatch(title, term) + fuzzyMatch(originalTitle, term) + fuzzyMatch(overview, term) * 0.5;
                score += fuzzyMatches * 25;

                // Even more flexible matching for short terms
                if (term.length >= 2) {
                    const shortFuzzyMatches = shortFuzzyMatch(title, term) + shortFuzzyMatch(originalTitle, term) + shortFuzzyMatch(overview, term) * 0.3;
                    score += shortFuzzyMatches * 20;
                }
            });

            return score;
        }

        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 1;

            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;

            if (longer.length === 0) return 0;

            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

        function containsAsianCharacters(text) {
            // Check if text contains Korean, Japanese, or Chinese characters
            const asianCharRegex = /[\u1100-\u11FF\u3130-\u318F\uAC00-\uD7AF\u4E00-\u9FFF\u3040-\u309F\u30A0-\u30FF]/;
            return asianCharRegex.test(text);
        }

        function shortFuzzyMatch(text, pattern) {
            if (!text || !pattern || pattern.length < 2) return 0;

            const textLower = text.toLowerCase();
            const patternLower = pattern.toLowerCase();

            // Check if all characters of pattern exist in text in order
            let textIndex = 0;
            let patternIndex = 0;

            while (textIndex < textLower.length && patternIndex < patternLower.length) {
                if (textLower[textIndex] === patternLower[patternIndex]) {
                    patternIndex++;
                }
                textIndex++;
            }

            // Return score based on how much of the pattern was matched
            return patternIndex / patternLower.length;
        }

        function fuzzyMatch(text, pattern) {
            if (!text || !pattern) return 0;

            const textLower = text.toLowerCase();
            const patternLower = pattern.toLowerCase();

            // Exact match
            if (textLower === patternLower) return 3;

            // Starts with
            if (textLower.startsWith(patternLower)) return 2;

            // Contains
            if (textLower.includes(patternLower)) return 1;

            // Fuzzy character matching
            let score = 0;
            let patternIndex = 0;

            for (let i = 0; i < textLower.length && patternIndex < patternLower.length; i++) {
                if (textLower[i] === patternLower[patternIndex]) {
                    score++;
                    patternIndex++;
                }
            }

            return patternIndex === patternLower.length ? score / patternLower.length : 0;
        }

        function showLiveSearchResults(query) {
            if (query.length < 2) {
                hideLiveSearchResults();
                return;
            }

            // Show loading state
            showSearchLoading(true);

            // Use requestAnimationFrame for smooth updates
            requestAnimationFrame(async () => {
                try {
                    const allItems = await fetchAllContentForSearch();
                    const searchResults = allItems.map(item => {
                        const score = calculateRelevanceScore(item, query);
                        return { item, score };
                    }).filter(result => result.score > 0)
                      .sort((a, b) => b.score - a.score)
                      .slice(0, 8) // Show top 8 results
                      .map(result => result.item);

                    displayLiveSearchResults(searchResults, query);
                    showSearchLoading(false);
                } catch (error) {
                    console.error('Error in live search:', error);
                    showSearchLoading(false);
                }
            });
        }

        function displayLiveSearchResults(results, query) {
            let resultsContainer = document.getElementById('liveSearchResults');

            if (!resultsContainer) {
                resultsContainer = document.createElement('div');
                resultsContainer.id = 'liveSearchResults';
                resultsContainer.className = 'live-search-results';
                resultsContainer.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: var(--dark);
                    border: 2px solid var(--primary);
                    border-top: none;
                    border-radius: 0 0 15px 15px;
                    max-height: 500px;
                    overflow-y: auto;
                    z-index: 1000;
                    display: none;
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
                `;
                document.querySelector('.search-container').appendChild(resultsContainer);
            }

            if (results.length > 0) {
                resultsContainer.innerHTML = `
                    <div class="live-results-header" style="padding: 15px; border-bottom: 1px solid rgba(0,255,157,0.2); color: var(--primary); font-weight: bold;">
                        <i class="fas fa-search" aria-hidden="true"></i> Search Results (${results.length})
                    </div>
                    <div class="live-results-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 15px;">
                        ${results.map(item => createLiveResultCard(item, query)).join('')}
                    </div>
                `;
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.innerHTML = `
                    <div class="no-live-results" style="padding: 30px; text-align: center; color: #ccc;">
                        <i class="fas fa-search" style="font-size: 32px; color: var(--primary); margin-bottom: 15px;" aria-hidden="true"></i>
                        <p>No results found for "${query}"</p>
                        <small>Try different keywords or check spelling</small>
                    </div>
                `;
                resultsContainer.style.display = 'block';
            }
        }

        function createLiveResultCard(item, query) {
            const title = item.title || item.name || 'Untitled';
            const year = (item.release_date || item.first_air_date || '').split('-')[0];
            const posterPath = item.poster_path ? `${IMG_URL}${item.poster_path}` : 'https://via.placeholder.com/300x450/1a1a2e/00FF9D?text=No+Image';
            const type = item.type === 'movie' ? 'Movie' : 'TV Show';
            const rating = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';

            return `
                <div class="live-result-card" style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; cursor: pointer; transition: all 0.2s; display: flex; gap: 12px;"
                     onclick="selectLiveResult('${item.type}', ${item.id})">
                    <div class="live-result-poster" style="flex-shrink: 0;">
                        <img src="${posterPath}" alt="${title}" style="width: 60px; height: 90px; object-fit: cover; border-radius: 5px;">
                    </div>
                    <div class="live-result-info" style="flex: 1; min-width: 0;">
                        <h4 style="color: var(--primary); font-size: 0.9rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${highlightSearchTerm(title, query)}
                        </h4>
                        <div style="display: flex; gap: 8px; margin-bottom: 5px;">
                            <span style="background: rgba(0,255,157,0.2); color: var(--primary); padding: 2px 6px; border-radius: 8px; font-size: 0.7rem;">${year}</span>
                            <span style="background: rgba(255,46,99,0.2); color: var(--accent); padding: 2px 6px; border-radius: 8px; font-size: 0.7rem;">${type}</span>
                        </div>
                        <div style="color: #ffd700; font-size: 0.8rem;">
                            <i class="fas fa-star" aria-hidden="true"></i> ${rating}
                        </div>
                        ${item.overview ? `<p style="color: #ccc; font-size: 0.75rem; margin-top: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${highlightSearchTerm(item.overview.substring(0, 80), query)}...</p>` : ''}
                    </div>
                </div>
            `;
        }

        function selectLiveResult(type, id) {
            currentMode = type;
            showDetails(id);
            hideLiveSearchResults();
            hideSearchSuggestions();
        }

        function hideLiveSearchResults() {
            const container = document.getElementById('liveSearchResults');
            if (container) {
                container.style.display = 'none';
            }
        }

        function showSearchSuggestions(searchTerm, allItems) {
            const suggestions = generateSearchSuggestions(searchTerm, allItems);
            let suggestionsContainer = document.getElementById('searchSuggestions');

            if (!suggestionsContainer) {
                suggestionsContainer = document.createElement('div');
                suggestionsContainer.id = 'searchSuggestions';
                suggestionsContainer.className = 'search-suggestions';
                suggestionsContainer.style.cssText = `
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: var(--dark);
                    border: 2px solid var(--primary);
                    border-top: none;
                    border-radius: 0 0 15px 15px;
                    max-height: 250px;
                    overflow-y: auto;
                    z-index: 1000;
                    display: none;
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                `;
                document.querySelector('.search-container').appendChild(suggestionsContainer);
            }

            if (suggestions.length > 0) {
                suggestionsContainer.innerHTML = suggestions.map(suggestion => `
                    <div class="search-suggestion" onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')">
                        <i class="fas fa-search" aria-hidden="true"></i> ${highlightSearchTerm(suggestion, searchTerm)}
                    </div>
                `).join('');
                suggestionsContainer.style.display = 'block';
            } else {
                suggestionsContainer.style.display = 'none';
            }
        }

        function hideSearchSuggestions() {
            const container = document.getElementById('searchSuggestions');
            if (container) {
                container.style.display = 'none';
            }
        }

        function generateSearchSuggestions(searchTerm, allItems) {
            const suggestions = new Set();
            const searchLower = searchTerm.toLowerCase();

            // Get suggestions from titles
            allItems.forEach(item => {
                const title = item.title || item.name || '';
                if (title.toLowerCase().includes(searchLower)) {
                    // Add partial matches as suggestions
                    const words = title.split(' ');
                    words.forEach(word => {
                        if (word.toLowerCase().startsWith(searchLower) && word.length > searchLower.length) {
                            suggestions.add(word);
                        }
                    });
                }
            });

            return Array.from(suggestions).slice(0, 8);
        }

        function selectSuggestion(suggestion) {
            searchInput.value = suggestion;
            performAdvancedSearch(suggestion);
            hideSearchSuggestions();
        }

        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;

            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function showSearchLoading(show) {
            let loadingIndicator = document.getElementById('searchLoading');

            if (show && !loadingIndicator) {
                loadingIndicator = document.createElement('div');
                loadingIndicator.id = 'searchLoading';
                loadingIndicator.className = 'search-loading';
                loadingIndicator.innerHTML = `
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    <span style="margin-left: 8px;">Searching...</span>
                `;
                loadingIndicator.style.cssText = `
                    position: absolute;
                    top: 50%;
                    right: 120px;
                    transform: translateY(-50%);
                    color: var(--primary);
                    font-size: 14px;
                    z-index: 1000;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    background: rgba(0, 0, 0, 0.7);
                    padding: 8px 12px;
                    border-radius: 20px;
                    border: 1px solid rgba(0, 255, 157, 0.3);
                    box-shadow: 0 4px 15px rgba(0, 255, 157, 0.2);
                `;
                document.querySelector('.search-container').appendChild(loadingIndicator);

                // Add sparkle effect
                setTimeout(() => {
                    if (loadingIndicator && loadingIndicator.parentNode) {
                        loadingIndicator.style.animation = 'sparklePulse 1s ease-in-out infinite';
                    }
                }, 100);

            } else if (!show && loadingIndicator) {
                loadingIndicator.style.animation = 'fadeOut 0.3s ease-out forwards';
                setTimeout(() => {
                    if (loadingIndicator && loadingIndicator.parentNode) {
                        loadingIndicator.remove();
                    }
                }, 300);
            }
        }

        // Add sparkle pulse animation
        const sparklePulseStyle = document.createElement('style');
        sparklePulseStyle.textContent = `
            @keyframes sparklePulse {
                0%, 100% {
                    box-shadow: 0 4px 15px rgba(0, 255, 157, 0.2);
                    transform: translateY(-50%) scale(1);
                }
                50% {
                    box-shadow: 0 6px 20px rgba(0, 255, 157, 0.4);
                    transform: translateY(-50%) scale(1.02);
                }
            }

            @keyframes fadeOut {
                from {
                    opacity: 1;
                    transform: translateY(-50%) scale(1);
                }
                to {
                    opacity: 0;
                    transform: translateY(-50%) scale(0.9);
                }
            }
        `;
        document.head.appendChild(sparklePulseStyle);

        function updateSearchResultsCounter(resultCount) {
            let counter = document.getElementById('searchResultsCounter');

            if (!counter) {
                counter = document.createElement('div');
                counter.id = 'searchResultsCounter';
                counter.className = 'search-results-counter';
                document.querySelector('.content-grid-wrapper').insertBefore(counter, document.querySelector('.content-grid'));
            }

            if (currentQuery) {
                const itemText = resultCount === 1 ? 'result' : 'results';
                counter.innerHTML = `
                    <div style="background: var(--dark); padding: 15px 25px; margin-bottom: 25px; border-radius: 10px; border-left: 4px solid var(--primary); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
                        <i class="fas fa-search" style="color: var(--primary); margin-right: 10px;" aria-hidden="true"></i>
                        Found <strong>${resultCount}</strong> ${itemText}
                        for <strong>"${currentQuery}"</strong>
                    </div>
                `;
                counter.style.display = 'block';
            } else {
                counter.style.display = 'none';
            }
        }

        // Switch between movie and TV mode
        function switchMode(mode) {
            currentMode = mode;
            currentPage = 1;
            contentGrid.innerHTML = '';

            // Update active button
            movieModeBtn.classList.toggle('active', mode === 'movie');
            tvModeBtn.classList.toggle('active', mode === 'tv');

            fetchContent();
        }

        // Fetch content from TMDB API
        async function fetchContent() {
            if (isFetching) return;
            isFetching = true;

            loadingElement.style.display = 'block';
            loadMoreBtn.style.display = 'none';

            try {
                let endpoint;
                if (currentQuery) {
                    endpoint = currentMode === 'movie'
                        ? `${API_URL}/search/movie?query=${currentQuery}&page=${currentPage}`
                        : `${API_URL}/search/tv?query=${currentQuery}&page=${currentPage}`;
                } else {
                    endpoint = currentMode === 'movie'
                        ? `${API_URL}/movie/popular?page=${currentPage}`
                        : `${API_URL}/tv/popular?page=${currentPage}`;
                }

                const response = await fetch(endpoint);
                const data = await response.json();

                displayContent(data.results);

                // Show load more button if there are more pages
                if (data.page < data.total_pages) {
                    loadMoreBtn.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching content:', error);
                contentGrid.innerHTML = '<p>Error loading content. Please try again later.</p>';
            } finally {
                isFetching = false;
                loadingElement.style.display = 'none';
            }
        }

        // Fetch hero movies
        async function fetchHeroMovies() {
            try {
                const response = await fetch(`${API_URL}/movie/popular?page=1`);
                const data = await response.json();
                const newHeroMovies = data.results.slice(0, 10);

                if (newHeroMovies.length > 0) {
                    heroMovies = newHeroMovies;
                    // Don't reset index here, let the slideshow loop naturally.
                    // If the slideshow isn't running, restartHeroSlideshow will handle it.
                    if (!slideshowInterval) {
                        currentHeroIndex = 0;
                    }

                    // Restart slideshow with new movies
                    restartHeroSlideshow();
                } else {
                    console.warn('No hero movies received from API');
                }
            } catch (error) {
                console.error('Error fetching hero movies:', error);
            }
        }

        // Update hero section
        // This variable is used to ensure button clicks correspond to the displayed movie
        let currentDisplayedMovie = null;

        function updateHero() {
            if (heroMovies.length === 0) return;

            const movie = heroMovies[currentHeroIndex];
            const title = movie.title;
            const overview = movie.overview;
            const backdropPath = movie.backdrop_path;
            const backdrop = backdropPath ? `https://image.tmdb.org/t/p/original${backdropPath}` : 'https://image.tmdb.org/t/p/original/8rpDcsfLJypbO6vREc0547VKqEv.jpg';

            // Set the current displayed movie for button synchronization
            currentDisplayedMovie = movie;

            // Add fade effect
            const heroElement = document.querySelector('.hero');
            heroElement.style.opacity = '0.7';

            setTimeout(() => {
                document.getElementById('heroTitle').textContent = title;
                document.getElementById('heroDesc').textContent = overview ? overview.substring(0, 200) + '...' : 'No description available.';
                heroElement.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('${backdrop}')`;
                heroElement.style.opacity = '1';

                // Update status indicator
                updateHeroStatus(movie);
            }, 300);

            // Update index for the *next* slide
            currentHeroIndex = (currentHeroIndex + 1) % heroMovies.length;
        }

        // Update hero status indicator
        function updateHeroStatus(movie) {
            const statusElement = document.getElementById('heroStatus');
            if (statusElement && movie) {
                const year = movie.release_date ? new Date(movie.release_date).getFullYear() : '';
                const rating = movie.vote_average ? movie.vote_average.toFixed(1) : '';

                statusElement.innerHTML = `
                    <i class="fas fa-film" aria-hidden="true"></i>
                    Now Showing: <strong>${movie.title}</strong>
                    ${year ? `<span class="year-badge">${year}</span>` : ''}
                    ${rating ? `<span class="rating-badge"><i class="fas fa-star" aria-hidden="true"></i> ${rating}</span>` : ''}
                `;
            }
        }

        // Start hero slideshow
        function startHeroSlideshow() {
            if (heroMovies.length <= 1) {
                return;
            }

            // Update hero every 8 seconds
            slideshowInterval = setInterval(() => {
                if (heroMovies.length > 0 && !isPaused) {
                    updateHero();
                }
            }, 8000);

            // Pause slideshow on hover
            const heroElement = document.querySelector('.hero');
            if (heroElement) {
                heroElement.addEventListener('mouseenter', () => {
                    isPaused = true;
                });

                heroElement.addEventListener('mouseleave', () => {
                    isPaused = false;
                });
            }

            // Also update hero immediately
            updateHero();
        }

        // Get the currently displayed movie (safe method)
        function getCurrentDisplayedMovie() {
            if (heroMovies.length === 0) return null;
            // currentDisplayedMovie is reliably set by updateHero().
            // If it's null (e.g., on first load before updateHero runs),
            // we can safely fall back to the movie at the *previous* index,
            // which is what would be displayed.
            const displayedIndex = (currentHeroIndex - 1 + heroMovies.length) % heroMovies.length;
            return currentDisplayedMovie || heroMovies[displayedIndex];
        }

        // Function to restart slideshow (useful if movies are reloaded)
        function restartHeroSlideshow() {
            console.log('Restarting hero slideshow...');
            if (slideshowInterval) {
                clearInterval(slideshowInterval);
                slideshowInterval = null;
            }
            if (heroMovies.length > 1) {
                startHeroSlideshow();
            } else if (heroMovies.length === 1) {
                console.log('Only one hero movie available, displaying static');
                updateHero(); // Show the single movie
            } else {
                console.warn('No hero movies available for slideshow');
            }
        }

        // Manual sync function for debugging
        function syncButtonsWithDisplay() {
            const currentMovie = getCurrentDisplayedMovie();
            console.log('Manual sync - Current displayed movie:', currentMovie?.title);
            console.log('Current hero index:', currentHeroIndex);
            console.log('Total hero movies:', heroMovies.length);

            if (currentMovie) {
                console.log('✅ Buttons are synced with:', currentMovie.title);
            } else {
                console.log('❌ No current movie available');
            }

            return currentMovie;
        }

        // Force refresh of button states
        function refreshButtonStates() {
            const currentMovie = getCurrentDisplayedMovie();

            if (currentMovie) {
                console.log('Refreshing button states for:', currentMovie.title);

                // Update any UI elements that show current movie info
                const heroTitle = document.getElementById('heroTitle');
                const heroDesc = document.getElementById('heroDesc');

                if (heroTitle && heroDesc) {
                    console.log('✅ Hero display is current');
                } else {
                    console.log('❌ Hero elements not found');
                }
            }
        }

        // Display content in the grid
        function displayContent(items) {
            if (items.length === 0) {
                const searchTerm = searchInput.value.trim();
                contentGrid.innerHTML = ` 
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #ccc; background: var(--dark); border-radius: 15px;">
                        <i class="fas fa-search" style="font-size: 64px; color: var(--primary); margin-bottom: 30px;" aria-hidden="true"></i>
                        <h3 style="font-size: 1.5rem; margin-bottom: 15px;">No results found</h3>
                        <p style="font-size: 1.1rem; margin-bottom: 20px;">
                            ${searchTerm ? `Try searching for something else or check your spelling.` : 'No content available at the moment.'}
                        </p>
                        ${searchTerm ? `<p style="color: var(--primary);"><strong>Searched for:</strong> "${searchTerm}"</p>` : ''}
                    </div>
                `;
                return;
            }

            items.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'content-card';

                const title = currentMode === 'movie' ? item.title : item.name;
                const date = currentMode === 'movie' ? item.release_date : item.first_air_date;
                const posterPath = item.poster_path ? `${IMG_URL}${item.poster_path}` : 'https://via.placeholder.com/300x450/1a1a2e/00FF9D?text=No+Image';

                // Get current search term for highlighting
                const searchTerm = searchInput.value.trim();
                const highlightedTitle = highlightSearchTerm(title, searchTerm);

                // Enhanced card with better metadata
                const year = date ? new Date(date).getFullYear() : 'N/A';
                const rating = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
                const type = currentMode === 'movie' ? 'Movie' : 'TV Show';

                card.innerHTML = `
                    <img src="${posterPath}" alt="${title}" class="card-img">
                    <div class="card-content">
                        <h3 class="card-title">${highlightedTitle}</h3>
                        <div class="card-info">
                            <span class="year-badge">${year}</span>
                            <span class="rating-badge"><i class="fas fa-star" aria-hidden="true"></i> ${rating}</span>
                            <span class="type-badge">${type}</span>
                        </div>
                        ${item.overview ? `<p class="card-overview">${truncateText(highlightSearchTerm(item.overview, searchTerm), 120)}</p>` : ''}
                        <div class="card-cast" id="cast-${item.id}" style="margin-top: 10px; min-height: 40px;">
                            <div class="cast-loading" style="display: flex; align-items: center; gap: 8px; color: #999; font-size: 0.75rem;">
                                <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                                <span>Loading cast & crew...</span>
                            </div>
                        </div>
                        <button class="watch-btn-card" data-item-id="${item.id}">
                            <i class="fas fa-play" aria-hidden="true"></i> Watch Now
                        </button>
                    </div>
                `;

                // Load cast information for this item (with slight delay to prevent overwhelming the API)
                setTimeout(() => {
                    loadCastInfo(item.id, item.type || currentMode);
                }, index * 100); // Stagger the requests

                // Add event listener for watch button
                const watchBtnCard = card.querySelector('.watch-btn-card');
                watchBtnCard.addEventListener('click', (e) => {
                    e.stopPropagation();
                    playVideo(item);
                });

                card.addEventListener('click', () => {
                    showDetails(item.id);
                });

                contentGrid.appendChild(card);
            });
        }

        // Load cast information for a movie/TV show
        async function loadCastInfo(itemId, type) {
            try {
                console.log(`Loading cast info for ${type} ID: ${itemId}`);

                // Check if we have test data for this item
                if (window.testCastData && window.testCastData[itemId]) {
                    console.log('Using test cast data for ID:', itemId);
                    displayCastInfo(itemId, window.testCastData[itemId]);
                    return;
                }

                const endpoint = `${API_URL}/${type}/${itemId}/credits`;
                const response = await fetch(endpoint);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Cast data received:', data);

                displayCastInfo(itemId, data);

            } catch (error) {
                console.error('Error loading cast info:', error);

                // Try to use test data as fallback
                if (window.testCastData && window.testCastData[itemId]) {
                    console.log('Using test cast data as fallback');
                    displayCastInfo(itemId, window.testCastData[itemId]);
                    return;
                }

                const castContainer = document.getElementById(`cast-${itemId}`);
                if (castContainer) {
                    castContainer.innerHTML = '<small style="color: #999; font-size: 0.7rem;">Cast info not available</small>';
                }
            }
        }

        function displayCastInfo(itemId, data) {
            const castContainer = document.getElementById(`cast-${itemId}`);
            if (!castContainer) {
                console.log('Cast container not found for ID:', itemId);
                return;
            }

            console.log('Displaying cast info for item:', itemId, 'Data:', data);

            if (data.cast && data.cast.length > 0) {
                const topCast = data.cast.slice(0, 3); // Show top 3 cast members
                const director = data.crew ? data.crew.find(person => person.job === 'Director') : null;

                console.log('Director found:', director);
                console.log('Top cast:', topCast);

                castContainer.innerHTML = `
                    <div class="cast-info">
                        ${director ? `<div class="director-info">
                            <div class="director-badge"> 
                                <i class="fas fa-crown" aria-hidden="true"></i>
                                <span>${director.name}</span>
                            </div>
                        </div>` : ''}
                        <div class="cast-members">
                            <div class="cast-label">
                                <i class="fas fa-users" aria-hidden="true"></i>
                                <span>Cast</span> 
                            </div>
                            ${topCast.map((actor, index) => `
                                <div class="cast-member">
                                    <img data-src="${actor.profile_path ? `https://image.tmdb.org/t/p/w342${actor.profile_path}` : ''}"
                                         data-fallback="https://via.placeholder.com/32x32/1a1a2e/00FF9D?text=👤"
                                         alt="${actor.name}"
                                         loading="lazy"
                                         style="background: rgba(0,255,157,0.1);">
                                    <span class="cast-member-name">${truncateText(actor.name, 15)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                console.log('Cast info displayed successfully for item:', itemId);
            } else {
                castContainer.innerHTML = '<small style="color: #999; font-size: 0.7rem; padding: 8px 0; border-top: 1px solid rgba(0,255,157,0.1);">Cast info not available</small>';
            }
        }

        function truncateText(text, maxLength) {
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        // Enhanced image loading with professional error handling
        function loadImageWithFallback(imgElement, src, fallbackSrc, showError = false) {
            return new Promise((resolve, reject) => {
                // Add loading class
                imgElement.classList.add('image-loading');

                const img = new Image();

                img.onload = () => {
                    imgElement.src = src;
                    imgElement.classList.remove('image-loading');
                    imgElement.classList.remove('image-error');
                    resolve(src);
                };

                img.onerror = () => {
                    if (fallbackSrc && imgElement.src !== fallbackSrc) {
                        // Try fallback image
                        imgElement.src = fallbackSrc;
                        imgElement.classList.remove('image-loading');
                        imgElement.classList.remove('image-error');
                        resolve(fallbackSrc);
                    } else if (showError) {
                        // Show error state
                        imgElement.classList.remove('image-loading');
                        imgElement.classList.add('image-error');
                        reject(new Error('Image failed to load'));
                    } else {
                        // Use placeholder
                        imgElement.src = fallbackSrc || 'https://via.placeholder.com/100x100/1a1a2e/00FF9D?text=👤';
                        imgElement.classList.remove('image-loading');
                        imgElement.classList.remove('image-error');
                        resolve(fallbackSrc);
                    }
                };

                img.src = src;
            });
        }

        // Batch image loader for better performance
        function loadImagesBatch(imageElements) {
            const promises = imageElements.map(element => {
                const src = element.getAttribute('data-src') || element.src;
                const fallbackSrc = element.getAttribute('data-fallback');
                return loadImageWithFallback(element, src, fallbackSrc, true);
            });

            return Promise.allSettled(promises);
        }

        // Load more content
        function loadMore() {
            currentPage++;
            fetchContent();
        }

        // Show details in modal
        async function showDetails(itemId) {
            try {
                const endpoint = `${API_URL}/${currentMode}/${itemId}`;
                const response = await fetch(endpoint);
                if (!response.ok) throw new Error('Failed to fetch details.');
                const item = await response.json();

                currentItem = item;

                const title = currentMode === 'movie' ? item.title : item.name;
                const date = currentMode === 'movie' ? item.release_date : item.first_air_date;
                const posterPath = item.poster_path ? `https://image.tmdb.org/t/p/w780${item.poster_path}` : 'https://via.placeholder.com/780x1170/1a1a2e/00FF9D?text=No+Image';

                modalTitle.textContent = title;
                modalPoster.src = posterPath;
                modalDate.textContent = date || 'N/A';
                modalRating.textContent = item.vote_average ? `${item.vote_average.toFixed(1)}/10` : 'N/A';
                modalLanguage.textContent = item.original_language ? item.original_language.toUpperCase() : 'N/A';
                modalOverview.textContent = item.overview || 'No overview available.';

                if (currentMode === 'movie') {
                    modalRuntime.textContent = item.runtime ? `${item.runtime} min` : 'N/A';
                } else {
                    modalRuntime.textContent = item.episode_run_time && item.episode_run_time.length > 0 ? `${item.episode_run_time[0]} min` : 'N/A';
                }

                modalGenres.textContent = item.genres ? item.genres.map(g => g.name).join(', ') : 'N/A';

                // Load cast and crew information
                loadCastAndCrew(itemId, currentMode);

                detailModal.style.display = 'block';
            } catch (error) {
                console.error('Error showing details:', error);
                alert('Could not load details for this item. Please try again.');
            }
        }

        // Load cast and crew information
        async function loadCastAndCrew(itemId, type) {
            try {
                console.log(`Loading cast and crew for ${type} ID: ${itemId}`);

                // Check if we have test data for this item
                if (window.testCastData && window.testCastData[itemId]) {
                    console.log('Using test cast data for modal');
                    updateModalWithCast(window.testCastData[itemId]);
                    return;
                }

                const endpoint = `${API_URL}/${type}/${itemId}/credits`;
                const response = await fetch(endpoint);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('Cast and crew data received:', data);

                // Update modal with cast and crew info
                updateModalWithCast(data);

            } catch (error) {
                console.error('Error loading cast and crew:', error);

                // Try to use test data as fallback
                if (window.testCastData && window.testCastData[itemId]) {
                    console.log('Using test cast data as fallback for modal');
                    updateModalWithCast(window.testCastData[itemId]);
                    return;
                }

                updateModalWithCast({ cast: [], crew: [] }); // Show empty state
            }
        }

        function updateModalWithCast(creditsData) {
            const modalDetails = document.querySelector('.modal-details');

            // Remove existing cast/crew info
            const existingCastInfo = document.getElementById('modalCastInfo');
            if (existingCastInfo) {
                existingCastInfo.remove();
            }

            // Create cast and crew section
            const castInfoDiv = document.createElement('div');
            castInfoDiv.id = 'modalCastInfo';
            castInfoDiv.className = 'cast-crew-info';

            console.log('Updating modal with cast data:', creditsData);

            if (creditsData.cast && creditsData.cast.length > 0) {
                const director = creditsData.crew ? creditsData.crew.find(person => person.job === 'Director') : null;
                const topCast = creditsData.cast.slice(0, 6); // Show top 6 cast members

                console.log('Director found for modal:', director);
                console.log('Top cast:', topCast);

                castInfoDiv.innerHTML = `
                    <div class="director-section"> 
                        <h3><i class="fas fa-crown" aria-hidden="true"></i> Director</h3>
                        ${director ? `
                            <div class="director-card">
                                <div class="director-profile">
                                    <img data-src="https://image.tmdb.org/t/p/w342${director.profile_path || ''}"
                                         data-fallback="https://via.placeholder.com/100x100/1a1a2e/00FF9D?text=👤"
                                         alt="${director.name}"
                                         class="director-avatar"
                                         style="background: rgba(0,255,157,0.1);">
                                    <div class="director-details">
                                        <h4>${director.name}</h4>
                                        <span class="director-role">Director</span>
                                    </div>
                                </div>
                            </div>
                        ` : '<p style="color: #999; font-style: italic; padding: 20px; background: rgba(255,255,255,0.02); border-radius: 8px; text-align: center;">Director information not available.</p>'}
                    </div>

                    <div class="cast-section"> 
                        <h3><i class="fas fa-users" aria-hidden="true"></i> Top Cast</h3>
                        <div class="cast-grid">
                            ${topCast.map(actor => `
                                <div class="cast-card">
                                    <div class="cast-profile">
                                        <img data-src="https://image.tmdb.org/t/p/w342${actor.profile_path || ''}"
                                             data-fallback="https://via.placeholder.com/75x75/1a1a2e/00FF9D?text=👤"
                                             alt="${actor.name}"
                                             class="cast-avatar"
                                             style="background: rgba(0,255,157,0.1);">
                                        <div class="cast-details">
                                            <h5>${actor.name}</h5>
                                            <span class="cast-character">as ${actor.character || 'Unknown Role'}</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                castInfoDiv.innerHTML = '<p style="color: #999;">Cast information not available.</p>';
            }

            // Insert cast info after the overview
            const watchBtn = modalDetails.querySelector('.watch-btn');
            if (watchBtn) {
                modalDetails.insertBefore(castInfoDiv, watchBtn);
            } else {
                modalDetails.appendChild(castInfoDiv);
            }
        }

        // Play video in modal
        async function playVideo(item) {
            currentItem = item;
            detailModal.style.display = 'none';

            // Create video modal if it doesn't exist
            if (!document.getElementById('videoModal')) {
                const videoModalHTML = `
                    <div class="video-modal" id="videoModal">
                        <div class="video-modal-content">
                            <div class="video-header">
                                <div class="video-title" id="videoTitle">Now Playing</div>
                                <div class="provider-buttons" id="providerButtons">
                                    <button class="provider-btn-small" data-provider="alpha">Alpha</button>
                                    <button class="provider-btn-small" data-provider="bravo">Bravo</button>
                                    <button class="provider-btn-small" data-provider="charlie">Charlie</button>
                                    <button class="provider-btn-small" data-provider="delta">Delta</button>
                                    <button class="provider-btn-small" data-provider="echo">Echo</button>
                                    <button class="provider-btn-small" data-provider="foxtrot">Foxtrot</button>
                                    <button class="provider-btn-small" data-provider="golf">Golf</button>
                                    <button class="provider-btn-small" data-provider="hotel">Hotel</button>
                                    <button class="provider-btn-small" data-provider="india">India</button>
                                    <button class="provider-btn-small" data-provider="juliet">Juliet</button>
                                    <button class="provider-btn-small" data-provider="kilo">Kilo</button>
                                    <button class="provider-btn-small" data-provider="lima">Lima</button>
                                    <button class="provider-btn-small" data-provider="mike">Mike</button>
                                    <button class="provider-btn-small" data-provider="november">November (4K)</button>
                                </div>
                                <div class="video-quality">HD</div>
                                <button class="close-video" id="closeVideo">&times;</button>
                            </div>
                            <div class="video-player">
                                <div class="video-loading" id="videoLoading">
                                    <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                                    <span>Loading stream...</span>
                                </div>
                                <iframe class="stream-iframe" id="streamIframe" allow="autoplay; encrypted-media; picture-in-picture; fullscreen"
                                    referrerpolicy="strict-origin-when-cross-origin">
                                </iframe>
                                <div class="player-controls" id="playerControls">
                                    <div class="controls-top">
                                        <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
                                    </div>
                                    <div class="controls-bottom">
                                        <div class="progress-container" id="progressContainer">
                                            <div class="progress-bar" id="progressBar"></div>
                                        </div>
                                        <button class="fullscreen-btn" id="fullscreenBtn"><i class="fas fa-expand" aria-hidden="true"></i></button>
                                        <button class="next-episode-btn" id="nextEpisodeBtn"><i class="fas fa-step-forward" aria-hidden="true"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', videoModalHTML);
            }

            // Get elements
            const videoModal = document.getElementById('videoModal');
            const streamIframe = document.getElementById('streamIframe');
            const videoLoading = document.getElementById('videoLoading');
            const closeVideo = document.getElementById('closeVideo');
            const providerButtons = document.getElementById('providerButtons');
            const videoTitle = document.getElementById('videoTitle');

            // Set title
            videoTitle.textContent = currentMode === 'movie' ? item.title : item.name;

            // Provider buttons
            const providerBtns = providerButtons.querySelectorAll('.provider-btn-small');

            // Function to load provider
            const loadProvider = async (providerName) => {
                const btn = Array.from(providerBtns).find(b => b.dataset.provider === providerName);
                if (!btn) {
                    console.error(`Provider button for '${providerName}' not found.`);
                    return;
                }

                const btn = providerBtns[index];
                const provider = btn.getAttribute('data-provider');

                // Update active button
                providerBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                videoLoading.style.display = 'flex';

                try {
                    // Fetch stream URL from worker
                    const params = new URLSearchParams({
                        provider: provider,
                        type: currentMode,
                        id: currentItem.id
                    });
                    if (currentMode === 'tv') {
                        params.append('s', '1');
                        params.append('e', '1');
                    }
                    const response = await fetch(`${API_URL}/stream/?${params}`);
                    if (!response.ok) throw new Error('Failed to fetch stream URL');
                    const data = await response.json();
                    const url = data.url;

                    streamIframe.src = url;

                    // Listen for iframe load to clear timeout
                    streamIframe.onload = () => {
                        videoLoading.style.display = 'none';
                    };

                } catch (error) {
                    console.error('Error fetching video URL:', error);
                    videoLoading.innerHTML = '<span>Failed to load. Try another provider.</span>';
                }
            };

            // Set up provider button event listeners
            providerBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const provider = btn.dataset.provider;
                    loadProvider(provider);
                });
            });

            // Set up player controls
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            fullscreenBtn.addEventListener('click', () => {
                const player = document.querySelector('.video-player');
                if (player.requestFullscreen) {
                    player.requestFullscreen();
                } else if (player.webkitRequestFullscreen) {
                    player.webkitRequestFullscreen();
                } else if (player.msRequestFullscreen) {
                    player.msRequestFullscreen();
                }
            });

            // Set up close video event listener
            closeVideo.addEventListener('click', () => {
                stopVideo();
                videoModal.style.display = 'none';
                detailModal.style.display = 'block';
            });

            // Also stop video when pressing ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && videoModal.style.display === 'block') {
                    stopVideo();
                    videoModal.style.display = 'none';
                    detailModal.style.display = 'block';
                }
            });

            // Show the video modal and start loading first provider
            videoModal.style.display = 'block';
            const firstProvider = providerBtns[0]?.dataset.provider;
            if (firstProvider) loadProvider(firstProvider);
        }

        // Function to stop video and audio
        function stopVideo() {
            const streamIframe = document.getElementById('streamIframe');
            if (streamIframe && streamIframe.parentNode) {
                const newIframe = streamIframe.cloneNode();
                streamIframe.parentNode.replaceChild(newIframe, streamIframe);
            }
            const videoLoading = document.getElementById('videoLoading');
            if (videoLoading) {
                videoLoading.style.display = 'flex';
            }
        }

        // Add typing animation effect
        function addTypingEffect() {
            const searchBox = document.getElementById('searchInput');
            if (!searchBox) return;

            let typingIndicator = document.getElementById('typingIndicator');
            if (!typingIndicator) {
                typingIndicator = document.createElement('div');
                typingIndicator.id = 'typingIndicator';
                typingIndicator.className = 'typing-indicator';
                typingIndicator.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                searchBox.parentNode.appendChild(typingIndicator);
            }

            typingIndicator.style.display = 'flex';

            // Add glow effect to search box while typing
            searchBox.style.boxShadow = `
                0 0 15px rgba(0, 255, 157, 0.3),
                0 0 30px rgba(0, 255, 157, 0.1),
                inset 0 0 15px rgba(0, 255, 157, 0.05)
            `;
        }

        // Remove typing animation effect
        function removeTypingEffect() {
            const searchBox = document.getElementById('searchInput');
            const typingIndicator = document.getElementById('typingIndicator');

            if (typingIndicator) {
                typingIndicator.style.display = 'none';
            }

            if (searchBox) {
                searchBox.style.boxShadow = '';
            }
        }

        // Make functions globally available for onclick handlers
        window.selectSuggestion = selectSuggestion;
        window.performAdvancedSearch = performAdvancedSearch;
        window.hideSearchSuggestions = hideSearchSuggestions;
        window.selectLiveResult = selectLiveResult;
        window.showLiveSearchResults = showLiveSearchResults;
        window.hideLiveSearchResults = hideLiveSearchResults;
        window.filterByGenre = filterByGenre;
        window.filterByYear = filterByYear;

        // Add trending category click handlers and ensure all categories work
        function attachCategoryEventListeners() {
            // Attach movie category listeners
            const movieCategories = document.querySelectorAll('#movieCategories .category-item');
            movieCategories.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const genreId = this.getAttribute('data-genre-id');
                    const genreType = this.getAttribute('data-genre-type');
                    const genreText = this.querySelector('span').textContent;
                    console.log('Movie category clicked:', genreText, 'ID:', genreId);
                    filterByGenre(parseInt(genreId), genreType, e);
                });
            });

            // Attach TV category listeners
            const tvCategories = document.querySelectorAll('#tvCategories .category-item');
            tvCategories.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const genreId = this.getAttribute('data-genre-id');
                    const genreType = this.getAttribute('data-genre-type');
                    const genreText = this.querySelector('span').textContent;
                    console.log('TV category clicked:', genreText, 'ID:', genreId);
                    filterByGenre(parseInt(genreId), genreType, e);
                });
            });

            // Attach year category listeners
            const yearCategories = document.querySelectorAll('#yearCategories .year-item');
            yearCategories.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const year = this.getAttribute('data-year');
                    console.log('Year category clicked:', year);
                    filterByYear(year, e);
                });
            });

            // Attach trending category listeners
            const trendingItems = document.querySelectorAll('.trending-item');
            trendingItems.forEach(item => {
                item.addEventListener('click', handleTrendingClick);
            });

            console.log('Category event listeners attached:', {
                movieCategories: movieCategories.length,
                tvCategories: tvCategories.length,
                yearCategories: yearCategories.length,
                trendingItems: trendingItems.length
            });
        }

        function handleTrendingClick(e) {
            e.preventDefault();
            e.stopPropagation();

            const text = e.target.textContent.trim();
            console.log('Trending clicked:', text);

            const searchInput = document.getElementById('searchInput');

            if (searchInput) {
                searchInput.value = text;
                performFullSearch(text);
                hideLiveSearchResults();
                hideSearchSuggestions();
            }
        }
    </script>
</body>
</html>
